<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta REC Dinámica</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --text-color: #2c3e50;
      --light-bg: #f8f9fa;
      --border-color: #e9ecef;
      --hover-bg: #e3f2fd;
      --card-shadow: rgba(0, 0, 0, 0.05) 0px 6px 24px 0px, rgba(0, 0, 0, 0.08) 0px 0px 0px 1px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background-color: #f5f7fa;
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
      font-size: 14px;
    }

    .app-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: var(--card-shadow);
      padding: 15px;
      margin-bottom: 20px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
    }

    /* Sección de búsqueda y acciones */
    .search-section {
      background-color: white;
      border-radius: 6px;
      padding: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 0;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 0;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 4px;
      font-weight: 500;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      font-size: 13px;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }

    .btn-success {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    
    .btn-success:hover {
      background-color: #27ae60;
      border-color: #27ae60;
    }

    .btn-warning {
      background-color: var(--warning-color);
      border-color: var(--warning-color);
      color: white;
    }
    
    .btn-warning:hover {
      background-color: #e67e22;
      border-color: #e67e22;
      color: white;
    }

    .btn-danger {
      background-color: var(--danger-color);
      border-color: var(--danger-color);
    }
    
    .btn-danger:hover {
      background-color: #c0392b;
      border-color: #c0392b;
    }

    /* Input de búsqueda */
    #recInput {
      margin: 5px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      font-size: 16px;
      width: 100%;
      transition: all 0.3s ease;
    }

    #recInput:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
      outline: none;
    }

    /* Contenedores de datos */
    .data-section {
      background-color: white;
      border-radius: 6px;
      padding: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    /* Elementos de mayoristas y empresas */
    .mayorista-item, .empresa-item {
      display: flex;
      align-items: center;
      padding: 8px;
      margin: 4px;
      gap: 8px;
      border-radius: 6px;
      background-color: var(--light-bg);
      transition: all 0.2s ease;
    }

    /* Estilo para container de mayoristas */
    #mayoristasContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    /* Estilo para cada mayorista (en línea) */
    .mayorista-item {
      flex: 0 0 auto;
      min-width: 240px;
    }

    .mayorista-item:hover, .empresa-item:hover {
      background-color: var(--hover-bg);
    }

    label {
      margin: 0;
      min-width: 100px;
      font-weight: 500;
      font-size: 13px;
    }

    input[type="number"] {
      width: 60px;
      padding: 4px 6px;
      text-align: center;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      font-size: 13px;
    }

    input[type="number"]:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
      outline: none;
    }

    .principal-input {
      background-color: #e3f2fd;
      font-weight: 600;
      border: 1px solid #bbdefb;
    }

    /* Estilos de tablas */
    table {
      border-collapse: collapse;
      width: 100%;
      margin: 20px 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }

    th, td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #e3f2fd;
      color: var(--primary-color);
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:nth-child(even) {
      background-color: var(--light-bg);
    }

    tr:hover {
      background-color: var(--hover-bg);
    }

    /* Contenedores */
    #mayoristasContainer, #empresasContainer {
      margin: 15px 0;
      padding: 15px;
      border-radius: 6px;
      background: white;
      box-shadow: var(--card-shadow);
    }

    /* Estilos para distribuciones */
    .distribute-btn {
      background-color: var(--secondary-color);
    }

    .clear-btn {
      background-color: var(--danger-color);
    }

    .total-row {
      background-color: #e3f2fd;
      font-weight: 600;
    }

    .valor-negativo {
      color: var(--danger-color);
      font-weight: 600;
    }

    /* Loading Spinner */
    #loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      font-size: 18px;
      color: var(--primary-color);
    }

    .spinner-border {
      margin-right: 10px;
      color: var(--primary-color);
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-color);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .filter-section {
      margin-bottom: 20px;
    }

    .filter-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .action-buttons {
        flex-direction: column;
        width: 100%;
      }
      
      .btn {
        width: 100%;
      }
      
      .mayorista-item, .empresa-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      input[type="number"] {
        width: 100%;
      }
    }

    /* Agrega esto al final de tu sección <style> */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.filter-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.filter-option:hover {
    background-color: #f5f5f5;
}

.filter-option input[type="checkbox"] {
    margin: 0;
}

.filter-option label {
    cursor: pointer;
    margin: 0;
    font-size: 14px;
}
  </style>
</head>
<body>
  <div id="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <span>Cargando datos...</span>
  </div>
  
  <div id="searchContainer" class="app-container" style="display:none">
    <div class="app-header">
      <h2 class="app-title">
        Distribución PandaDash
      </h2>
      
      <div class="action-buttons">
        <button class="btn btn-sm btn-primary" onclick="reloadAllData()">
          <i class="fas fa-sync-alt"></i> Actualizar
        </button>
        
        <button class="btn btn-sm btn-success" onclick="saveAllDistributionsFast()">
          <i class="fas fa-save"></i> Guardar
        </button>
        
        <button class="btn btn-sm btn-secondary" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>

        <button class="btn btn-danger btn-sm" onclick="confirmarCambio()">
          <i class="fas fa-repeat"></i> Cambiar
        </button>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <!-- Columna de búsqueda -->
      <div class="col-md-4">
        <div class="data-section h-100 mb-0">
          <h3 class="section-title">
            <i class="fas fa-file-invoice me-2"></i>Consultar Documento
          </h3>
          <div class="input-group position-relative">
            <input 
              type="number" 
              id="recInput" 
              class="form-control ps-5"
              placeholder="Número de REC" 
              aria-label="Número de REC"
              oninput="searchRec()"
            >
          </div>
        </div>
      </div>
      
      <!-- Columna de empresas -->
      <div class="col-md-8">
        <div class="data-section h-100 mb-0">
          <h3 class="section-title">
            <i class="fas fa-building me-2"></i>Distribución por Empresas
          </h3>
          <div id="empresasContainer" class="card-body p-2"></div>
        </div>
      </div>
    </div>
    
    <div class="data-section">
      <h3 class="section-title">
        <i class="fas fa-truck me-2"></i>Mayoristas Disponibles
      </h3>
      <div id="mayoristasContainer" class="card-body p-2"></div>
    </div>
    
    <div id="result"></div>
  </div>

  <!-- Modal para Filtros -->
  <div id="filterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="filterModalTitle">Filtrar Mayoristas</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="filter-section">
          <h5>Excluir Colores</h5>
          <div id="colorFilters" class="filter-options"></div>
        </div>
        <div class="filter-section">
          <h5>Excluir Tallas</h5>
          <div id="tallaFilters" class="filter-options"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" id="applyFilters">Aplicar Filtros</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // Variables globales
    const API_KEY = "AIzaSyC7hjbRc0TGLgImv8gVZg8tsOeYWgXlPcM";
    const SOURCE_SPREADSHEET_ID = "1esc5REq0c03nHLpGcLwZRW29yq2gZnrpbz75gCCjrqc";
    const SECONDARY_SPREADSHEET_ID = "133NiyjNApZGkEFs4jUvpJ9So-cSEzRVeW2FblwOCrjI";

    let allRecData = [];
    let allConfigData = {};
    let activeMayoristas = [];
    let empresasData = [];
    let currentRecData = null;
    let colorOptions = [];
    let tallaOptions = [];
    let mayoristaFilters = {};
    let currentFilterMayorista = null;

    // Configuración fija de clientes (reemplaza PropertiesService)
    const CLIENTES_CONFIG = {
      "67006141": {"id":"67006141","razonSocial":"QUINTERO ORTIZ PATRICIA YAMILET","nombreCorto":"Yamilet","tipoCliente":"Mayorista","estado":"Activo","direccion":"CL 26 # 7 - 21","telefono":"3122441788","email":"p.yamiletquino@hotmail.com"},
      "805027653": {"id":"805027653","razonSocial":"EL TEMPLO DE LA MODA S.A.S.","nombreCorto":"Templo","tipoCliente":"Empresa","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3143927031","email":"auxiliarcdi@eltemplodelamoda.com.co","tipoEmpresa":"Principal"},
      "900021825": {"id":"900021825","razonSocial":"INDUALPES S.A.S","nombreCorto":"Indualpes","tipoCliente":"Mayorista","estado":"Activo","direccion":"CR 52 29 A 111 BG 205","telefono":"","email":"gerencia@indualpes.com"},
      "900047252": {"id":"900047252","razonSocial":"EL TEMPLO DE LA MODA FRESCA S.A.S.","nombreCorto":"Shopping","tipoCliente":"Empresa","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3185859934","email":"bodega@eltemplodelamodafresca.com","tipoEmpresa":"Secundaria"},
      "900616124": {"id":"900616124","razonSocial":"TEXTILES Y CREACIONES EL UNIVERSO S.A.S.","nombreCorto":"Universo","tipoCliente":"Mayorista","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3168007979","email":"coordinadorlogistico@eltemplodelamoda.com.co"},
      "900692469": {"id":"900692469","razonSocial":"TEXTILES Y CREACIONES LOS ANGELES S.A.S.","nombreCorto":"Ángeles","tipoCliente":"Proveedor","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3154799895","email":"gerencia@tclosangeles.com"},
      "901920844": {"id":"901920844","razonSocial":"INVERSIONES URBANA SAS","nombreCorto":"Ruben","tipoCliente":"Mayorista","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3103944800","email":"contabilidad@eltemplodelamoda.com.co"},
      "1007348825": {"id":"1007348825","razonSocial":"ZULUAGA GOMEZ RUBEN ESTEBAN","nombreCorto":"Esteban","tipoCliente":"Mayorista","estado":"Activo","direccion":"CONDOMINIO CAMPESTRE LAS MERCEDES","telefono":"3205702698","email":"contabilidad@eltemplodelamoda.com.co"},
      "900616124-1": {"id":"900616124","razonSocial":"TEXTILES Y CREACIONES EL UNIVERSO S.A.S.","nombreCorto":"Universo","tipoCliente":"Proveedor","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3168007979","email":"coordinadorlogistico@eltemplodelamoda.com.co"},
      "70825517-1": {"id":"70825517","razonSocial":"ARISTIZABAL LOPEZ JESUS MARIA","nombreCorto":"Jesús","tipoCliente":"Mayorista","estado":"Activo","direccion":"CL 26 # 7 - 21","telefono":"3122441788","email":"p.yamiletquino@hotmail.com"},
      "70825517-2": {"id":"14838951","razonSocial":"QUINTERO ORTIZ JOSE ALEXANDER","nombreCorto":"Alex","tipoCliente":"Mayorista","estado":"Activo","direccion":"CL 26 # 7 - 21","telefono":"3104624213","email":"alexander511933@hotmail.com"}
    };

    // Cargar datos al iniciar
    function initialize() {
      document.getElementById('loading').style.display = 'flex';
      
      Promise.all([
        cargarTodosLosDatos(),
        cargarConfiguraciones()
      ]).then(([recData, configData]) => {
        handleRecData(recData);
        handleConfigData(configData);
      }).catch(handleError);
    }

    // Función para cargar datos unificados
    async function cargarTodosLosDatos() {
      try {
        const [json1, json2] = await Promise.all([
          getSheetDataAsJSON_1(),  // DATA2
          getSheetDataAsJSON_2()   // DataBase
        ]);

        const arr1 = JSON.parse(json1);
        const arr2 = JSON.parse(json2);
        const unified = arr1.concat(arr2);

        return unified;
      } catch (error) {
        console.error('Error cargando datos:', error);
        throw error;
      }
    }

    // REPLICA EXACTA de getSheetDataAsJSON_1() de GAS
    async function getSheetDataAsJSON_1() {
      const SPREADSHEET_ID = "133NiyjNApZGkEFs4jUvpJ9So-cSEzRVeW2FblwOCrjI";
      const SHEET_NAME = "DATA2";
      const RANGE = `${SHEET_NAME}!S2:S`;

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Error HTTP DATA2: ${response.status}`);
      }

      const data = await response.json();

      if (!data.values || data.values.length === 0) {
        return JSON.stringify({ error: "No data found" });
      }

      const jsonEntries = data.values.map(row => row[0]).filter(val => val && val.trim() !== "");
      const finalJsonString = `[${jsonEntries.join(",")}]`;

      return finalJsonString;
    }

    // REPLICA EXACTA de getSheetDataAsJSON_2() de GAS
    async function getSheetDataAsJSON_2() {
      const range = "DataBase!A:HR";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SOURCE_SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Error HTTP DataBase: ${response.status}`);
      }

      const data = await response.json();

      if (!data.values) {
        return JSON.stringify({ error: "No data found" });
      }

      const datos = data.values;
      let result = [];
      let lotesAnexos = {};
      let lotesHrPendientes = {};

      for (let i = 0; i < datos.length; i++) {
        if (datos[i][0]) {
          const valueA = datos[i][0].toString().trim();

          if (valueA.startsWith("REC")) {
            const numberPart = valueA.replace("REC", "").trim();
            
            let proveedor = "TEXTILES Y CREACIONES EL UNIVERSO S.A.S.";
            if (datos[i][3] && datos[i][3].toString().trim() === "LINEA ANGELES") {
              proveedor = "TEXTILES Y CREACIONES LOS ANGELES S.A.S.";
            }

            let loteActual = datos[i][8] || "";
            let tipoActual = datos[i][27] || "";

            if (!lotesAnexos[loteActual]) {
              lotesAnexos[loteActual] = [];
              lotesHrPendientes[loteActual] = [];
            }

            if (tipoActual !== "FULL") {
              lotesAnexos[loteActual].push({
                "DOCUMENTO": numberPart,
                "TIPO": tipoActual,
                "CANTIDAD": datos[i][18] || ""
              });

              if (tipoActual === "PENDIENTES" && datos[i][225]) {
                const hrPendiente = datos[i][225].toString().split("☬").map(row => row.split("∞"));
                lotesHrPendientes[loteActual] = lotesHrPendientes[loteActual].concat(hrPendiente);
              }
            }

            if (tipoActual === "FULL") {
              let extensiones = [];
              if (datos[i][225]) {
                extensiones = datos[i][225].toString().split("☬").map(row => row.split("∞"));
              }

              result.push({
                "A": numberPart,
                "FECHA": datos[i][1] || "",
                "TALLER": datos[i][2] || "",
                "LINEA": datos[i][3] || "",
                "AUDITOR": datos[i][4] || "",
                "ESCANER": datos[i][5] || "",
                "LOTE": loteActual,
                "REFERENCIA": datos[i][6] || "",
                "DESCRIPCIÓN": datos[i][9] || "",
                "CANTIDAD": datos[i][18] || "",
                "TEMPLO": datos[i][26] || "",
                "TIPO": tipoActual,
                "PVP": datos[i][28] || "",
                "PRENDA": datos[i][29] || "",
                "GENERO": datos[i][30] || "",
                "HR": extensiones,
                "PROVEEDOR": proveedor,
                "ANEXO": []
              });
            }
          }
        }
      }

      // Combinar HRs y anexos
      result.forEach(item => {
        if (lotesAnexos[item.LOTE]) {
          item.ANEXO = lotesAnexos[item.LOTE];
        }

        if (lotesHrPendientes[item.LOTE] && lotesHrPendientes[item.LOTE].length > 0) {
          const hrPrincipal = item.HR;
          const hrPendientes = lotesHrPendientes[item.LOTE];
          
          const combinedHrMap = {};
          
          hrPrincipal.forEach(itemHr => {
            const codigo = itemHr[0];
            if (codigo) combinedHrMap[codigo] = [...itemHr];
          });
          
          hrPendientes.forEach(itemHr => {
            const codigo = itemHr[0];
            if (codigo) {
              if (combinedHrMap[codigo]) {
                const cantidadExistente = parseInt(combinedHrMap[codigo][3]) || 0;
                const cantidadNueva = parseInt(itemHr[3]) || 0;
                combinedHrMap[codigo][3] = (cantidadExistente + cantidadNueva).toString();
              } else {
                combinedHrMap[codigo] = [...itemHr];
              }
            }
          });
          
          item.HR = Object.values(combinedHrMap);
        }
      });

      return JSON.stringify(result, null, 2);
    }

    // Cargar configuraciones desde objeto fijo
    function cargarConfiguraciones() {
      return new Promise((resolve) => {
        // Convertir el objeto CLIENTES_CONFIG al formato esperado
        const configArray = Object.entries(CLIENTES_CONFIG).map(([id, config]) => ({
          id: id,
          ...config
        }));
        resolve(configArray);
      });
    }

    function handleRecData(recData) {
      allRecData = recData;
      if (allConfigData) refreshUI();
    }
    
    function handleConfigData(configData) {
      allConfigData = configData.reduce((acc, config) => {
        acc[config.id] = config;
        return acc;
      }, {});
      processConfigData();
      if (allRecData) refreshUI();
    }
    
    function processConfigData() {
      // Procesar empresas
      empresasData = Object.entries(allConfigData)
        .filter(([id, config]) => config.tipoEmpresa)
        .sort((a, b) => {
          if (a[1].tipoEmpresa !== b[1].tipoEmpresa) {
            return a[1].tipoEmpresa === "Principal" ? -1 : 1;
          }
          return a[1].nombreCorto.localeCompare(b[1].nombreCorto);
        });
      
      // Inicializar filtros para mayoristas
      Object.entries(allConfigData)
        .filter(([id, config]) => config.tipoCliente === "Mayorista")
        .forEach(([id, config]) => {
          mayoristaFilters[id] = {
            excludedColors: [],
            excludedTallas: []
          };
        });
    }
    
    function refreshUI() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('searchContainer').style.display = 'block';
      document.getElementById('empresasContainer').innerHTML = '';
      document.getElementById('mayoristasContainer').innerHTML = '';
      generateEmpresasUI();
      generateMayoristasUI();
      const recNumber = document.getElementById('recInput').value.trim();
      if (recNumber) searchRec();
    }

    function generateEmpresasUI() {
      const container = document.getElementById('empresasContainer');
      container.innerHTML = '';

      if (empresasData.length === 0) {
        container.innerHTML = '<p>No hay empresas configuradas</p>';
        return;
      }

      const row = document.createElement('div');
      row.className = 'row g-3 align-items-center justify-content-start';

      empresasData.forEach(([id, config]) => {
        const col = document.createElement('div');
        col.className = 'col-auto d-flex align-items-center';

        const label = document.createElement('label');
        label.htmlFor = `empresa-${id}`;
        label.className = 'form-label mb-0 me-0';
        label.textContent = config.nombreCorto + ':';

        const input = document.createElement('input');
        input.type = 'number';
        input.id = `empresa-${id}`;
        input.className = 'form-control';
        input.min = '0';
        input.max = '100';
        input.value = config.tipoEmpresa === "Principal" ? '100' : '0';
        input.dataset.tipo = config.tipoEmpresa;
        input.dataset.id = id;
        input.style.width = '70px';

        if (config.tipoEmpresa === "Principal") {
          input.readOnly = true;
          input.classList.add('principal-input');
        } else {
          input.addEventListener('input', updateEmpresaPercentage);
        }

        col.appendChild(label);
        col.appendChild(input);
        row.appendChild(col);
      });

      container.appendChild(row);
    }
    
    function generateMayoristasUI() {
      const container = document.getElementById('mayoristasContainer');
      const mayoristas = Object.entries(allConfigData)
        .filter(([id, config]) => config.tipoCliente === "Mayorista")
        .sort((a, b) => a[1].nombreCorto.localeCompare(b[1].nombreCorto));
      
      if (mayoristas.length === 0) {
        container.innerHTML = '<p>No hay mayoristas configurados</p>';
        return;
      }
      
      mayoristas.forEach(([id, config]) => {
        const div = document.createElement('div');
        div.className = 'form-check form-switch';
        
        const checkboxDiv = document.createElement('div');
        checkboxDiv.className = 'form-check';
        
        const checkboxInput = document.createElement('input');
        checkboxInput.type = 'checkbox';
        checkboxInput.className = 'form-check-input';
        checkboxInput.id = `mayorista-${id}`;
        checkboxInput.value = id;
        checkboxInput.dataset.nombre = config.nombreCorto;
        checkboxInput.addEventListener('change', updateHrColumns);
        
        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = `mayorista-${id}`;
        label.textContent = config.nombreCorto;
        
        checkboxDiv.appendChild(checkboxInput);
        checkboxDiv.appendChild(label);
        
        div.appendChild(checkboxDiv);
        container.appendChild(div);
      });
    }

    // Función principal modificada para actualizar valores
    function updateAllValues() {
      if (!currentRecData || !currentRecData.HR) return;
      
      currentRecData.HR.forEach((row, rowIndex) => {
        const tr = document.querySelector(`tbody tr:nth-child(${rowIndex + 1})`);
        if (!tr) return;
        
        const total = parseInt(tr.cells[3].textContent) || 0;
        
        // 1. Calcular total asignado a mayoristas
        let assignedToMayoristas = 0;
        activeMayoristas.forEach(mayorista => {
          const input = tr.querySelector(`.mayorista-input[data-mayorista="${mayorista.id}"]`);
          assignedToMayoristas += parseInt(input?.value) || 0;
        });
        
        // 2. Validar que no se exceda el total
        if (assignedToMayoristas > total) {
          // Ajustar proporcionalmente los valores de mayoristas
          const ratio = total / assignedToMayoristas;
          activeMayoristas.forEach(mayorista => {
            const input = tr.querySelector(`.mayorista-input[data-mayorista="${mayorista.id}"]`);
            if (input && input.value > 0) {
              input.value = Math.max(1, Math.floor(parseInt(input.value) * ratio));
            }
          });
          assignedToMayoristas = total;
        }
        
        // 3. Calcular disponible para empresas
        const availableForCompanies = total - assignedToMayoristas;
        
        // 4. Asignar a empresas secundarias
        empresasData.forEach(([id, config]) => {
          if (config.tipoEmpresa === "Secundaria") {
            const input = document.getElementById(`empresa-${id}`);
            const porcentaje = input ? parseInt(input.value) || 0 : 0;
            const valorSecundaria = Math.round(availableForCompanies * porcentaje / 100);
            
            const secundariaCell = tr.querySelector(`.secundaria-cell[data-empresa="${id}"]`);
            if (secundariaCell) secundariaCell.textContent = valorSecundaria;
          }
        });
        
        // 5. Calcular valor para principal
        let asignadoSecundarias = 0;
        empresasData.forEach(([id, config]) => {
          if (config.tipoEmpresa === "Secundaria") {
            const secundariaCell = tr.querySelector(`.secundaria-cell[data-empresa="${id}"]`);
            asignadoSecundarias += parseInt(secundariaCell?.textContent) || 0;
          }
        });
        
        const principalValue = Math.max(0, availableForCompanies - asignadoSecundarias);
        const principalCell = tr.querySelector('.principal-cell');
        if (principalCell) principalCell.textContent = principalValue;
      });
      
      updateTotals();
    }

    function updateEmpresaPercentage(event) {
      const input = event.target;
      let value = parseInt(input.value) || 0;
      value = Math.max(0, Math.min(100, value));
      input.value = value;
      updatePrincipalValue();
      updateAllValues();
    }
    
    function updatePrincipalValue() {
      const principal = empresasData.find(([id, config]) => config.tipoEmpresa === "Principal");
      if (!principal) return;
      
      const principalInput = document.getElementById(`empresa-${principal[0]}`);
      if (!principalInput) return;
      
      let totalSecundarias = 0;
      empresasData.forEach(([id, config]) => {
        if (config.tipoEmpresa === "Secundaria") {
          const input = document.getElementById(`empresa-${id}`);
          if (input) totalSecundarias += parseInt(input.value) || 0;
        }
      });
      
      principalInput.value = 100 - totalSecundarias;
    }

    function updateMayoristaInput(event) {
      const input = event.target;
      const rowIndex = input.dataset.row;
      const mayoristaId = input.dataset.mayorista;
      const value = parseInt(input.value) || 0;
      const total = parseInt(document.querySelector(`tbody tr:nth-child(${parseInt(rowIndex) + 1}) td:nth-child(4)`).textContent) || 0;
      
      // Calcular lo asignado a otros mayoristas
      let assignedToOthers = 0;
      activeMayoristas.forEach(m => {
        if (m.id !== mayoristaId) {
          const otherInput = document.querySelector(`.mayorista-input[data-row="${rowIndex}"][data-mayorista="${m.id}"]`);
          assignedToOthers += parseInt(otherInput?.value) || 0;
        }
      });
      
      // Validar que no se exceda el total
      if (value + assignedToOthers > total) {
        input.value = Math.max(0, total - assignedToOthers);
      }
      
      updateAllValues();
    }

    function distributeGlobalQuantity(event) {
      const btn = event.target.closest('.distribute-btn');
      const mayoristaId = btn.dataset.mayorista;
      const input = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
      let totalToDistribute = parseInt(input.value) || 0;
      
      if (totalToDistribute <= 0) return;
      
      // Obtener filtros actuales para este mayorista
      const filters = mayoristaFilters[mayoristaId] || { excludedColors: [], excludedTallas: [] };
      
      // Obtener filas disponibles
      const rows = Array.from(document.querySelectorAll('tbody tr:not(.total-row)'))
        .filter(row => {
          const color = row.cells[1].textContent;
          const talla = row.cells[2].textContent;
          const total = parseInt(row.cells[3].textContent) || 0;
          return total > 0 && 
                 !filters.excludedColors.includes(color) && 
                 !filters.excludedTallas.includes(talla);
        });
      
      if (rows.length === 0) {
        alert('No hay filas disponibles para distribuir');
        return;
      }
      
      // Limpiar valores previos de este mayorista
      document.querySelectorAll(`.mayorista-input[data-mayorista="${mayoristaId}"]`).forEach(input => {
        input.value = '0';
      });
      
      // Preparar datos para distribución
      const availableRows = rows.map(row => {
        const rowIndex = Array.from(row.parentNode.children).indexOf(row);
        const total = parseInt(row.cells[3].textContent) || 0;
        
        // Calcular ya asignado a otros mayoristas
        let assignedToOthers = 0;
        activeMayoristas.forEach(m => {
          if (m.id !== mayoristaId) {
            const otherInput = row.querySelector(`.mayorista-input[data-mayorista="${m.id}"]`);
            assignedToOthers += parseInt(otherInput?.value) || 0;
          }
        });
        
        const disponible = Math.max(0, total - assignedToOthers);
        
        return {
          row: row,
          tdm: disponible,
          rowIndex: rowIndex
        };
      });
      
      // Ejecutar distribución inteligente
      const result = smartDistribution(availableRows, totalToDistribute);
      
      // Aplicar la distribución
      let totalAsignado = 0;
      result.forEach(item => {
        const input = item.row.querySelector(`.mayorista-input[data-mayorista="${mayoristaId}"]`);
        if (item.assigned > 0) {
          input.value = item.assigned;
          totalAsignado += item.assigned;
        }
      });
      
      // Ajustar el input global con lo realmente distribuido
      input.value = totalAsignado;
      
      // Actualizar valores de empresas con lo restante
      updateAllValues();
    }

    function updateTotals() {
      if (!currentRecData) return;
      
      const totalCantidad = currentRecData.HR.reduce((sum, row) => sum + (parseFloat(row[3]) || 0), 0);
      
      // Totales para mayoristas
      activeMayoristas.forEach(mayorista => {
        let total = 0;
        document.querySelectorAll(`.mayorista-input[data-mayorista="${mayorista.id}"]`).forEach(input => {
          total += parseInt(input.value) || 0;
        });
        const totalElement = document.querySelector(`.mayorista-total[data-mayorista="${mayorista.id}"]`);
        if (totalElement) totalElement.textContent = total;
      });
      
      // Totales para empresas
      empresasData.forEach(([id, config]) => {
        if (config.tipoEmpresa === "Principal") {
          let totalPrincipal = 0;
          document.querySelectorAll('.principal-cell').forEach(cell => {
            totalPrincipal += parseInt(cell.textContent) || 0;
          });
          const principalTotalElement = document.querySelector('.principal-total');
          if (principalTotalElement) {
            principalTotalElement.textContent = totalPrincipal;
            principalTotalElement.classList.toggle('valor-negativo', totalPrincipal < 0);
          }
        } else {
          let totalSecundaria = 0;
          document.querySelectorAll(`.secundaria-cell[data-empresa="${id}"]`).forEach(cell => {
            totalSecundaria += parseInt(cell.textContent) || 0;
          });
          const totalElement = document.querySelector(`.secundaria-total[data-empresa="${id}"]`);
          if (totalElement) totalElement.textContent = totalSecundaria;
        }
      });
    }

    function updateHrColumns() {
      const changedCheckbox = event.target;
      const mayoristaId = changedCheckbox.value;
      const isNowChecked = changedCheckbox.checked;
      
      // Guardar valores actuales de otros mayoristas
      const savedMayoristaValues = {};
      activeMayoristas.forEach(mayorista => {
        if (mayorista.id !== mayoristaId) {
          savedMayoristaValues[mayorista.id] = [];
          document.querySelectorAll(`.mayorista-input[data-mayorista="${mayorista.id}"]`).forEach((input, index) => {
            savedMayoristaValues[mayorista.id][index] = input.value;
          });
        }
      });
      
      // Guardar valores de empresas
      const savedEmpresaValues = {};
      empresasData.forEach(([id, config]) => {
        const input = document.getElementById(`empresa-${id}`);
        if (input) savedEmpresaValues[id] = input.value;
      });
      
      // Si se está deshabilitando un mayorista, limpiar sus valores
      if (!isNowChecked) {
        const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
        if (globalInput) globalInput.value = '0';
        
        document.querySelectorAll(`.mayorista-input[data-mayorista="${mayoristaId}"]`).forEach(input => {
          input.value = '0';
        });
      }
      
      // Actualizar lista de mayoristas activos
      activeMayoristas = [];
      document.querySelectorAll('#mayoristasContainer input[type="checkbox"]:checked').forEach(checkbox => {
        activeMayoristas.push({
          id: checkbox.value,
          nombre: checkbox.dataset.nombre
        });
      });
      
      // Refrescar UI preservando valores
      refreshDisplayPreservingValues({
        empresas: savedEmpresaValues,
        mayoristas: savedMayoristaValues
      });
      
      // Actualizar totales
      updateTotals();
    }

    function refreshDisplayPreservingValues(savedValues = {}) {
      const recNumber = document.getElementById('recInput').value.trim();
      if (!recNumber) return;
      
      if (currentRecData) {
        // Mostrar resultados preservando valores
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = generateResultsHTML(currentRecData);
        attachInputEvents();
        
        // Restaurar valores de empresas
        if (savedValues.empresas) {
          Object.keys(savedValues.empresas).forEach(id => {
            const input = document.getElementById(`empresa-${id}`);
            if (input) {
              input.value = savedValues.empresas[id];
              if (input.dataset.tipo === "Secundaria") {
                const event = new Event('input');
                input.dispatchEvent(event);
              }
            }
          });
        }
        
        // Restaurar valores de mayoristas
        if (savedValues.mayoristas) {
          Object.keys(savedValues.mayoristas).forEach(mayoristaId => {
            const values = savedValues.mayoristas[mayoristaId];
            values.forEach((value, rowIndex) => {
              const input = document.querySelector(`.mayorista-input[data-row="${rowIndex}"][data-mayorista="${mayoristaId}"]`);
              if (input) {
                input.value = value;
              }
            });
          });
        }
        
        updateAllValues();
      }
    }

    function searchRec() {
      const recNumber = document.getElementById('recInput').value.trim();
      const resultDiv = document.getElementById('result');
      
      if (!recNumber) {
        resultDiv.innerHTML = '';
        return;
      }
      
      currentRecData = allRecData.find(item => item.A === recNumber);
      displayResults(currentRecData);
    }
    
    function displayResults(recData) {
      const resultDiv = document.getElementById('result');
      
      if (!recData) {
        resultDiv.innerHTML = '<p>No se encontró el REC</p>';
        return;
      }
      
      resultDiv.innerHTML = generateResultsHTML(recData);
      attachInputEvents();
      updateAllValues();
    }

    function generateResultsHTML(recData) {
      let html = '<h3></h3>';
      
      if (!recData.HR || recData.HR.length === 0) {
        return html + '<p>No hay extensiones para este REC</p>';
      }
      
      html += '<table><thead><tr>';
      
      // Columnas fijas
      html += '<th>Código</th>';
      html += '<th>Color</th>';
      html += '<th>Talla</th>';
      html += '<th>Cantidad</th>';
      
      // Columnas de empresas
      empresasData.forEach(([id, config]) => {
        html += `<th>${config.nombreCorto}</th>`;
      });
      
      // Columnas de mayoristas
      activeMayoristas.forEach(mayorista => {
        html += `
          <th>
            <div class="mayorista-column-header">
              <div class="fw-bold text-primary small mb-1">${mayorista.nombre}</div>
              <div class="header-controls">
                <div class="btn-group btn-group-sm d-flex justify-content-start mb-1">
                  <button class="btn btn-sm btn-success distribute-btn px-2" data-mayorista="${mayorista.id}" title="Distribuir">
                    <i class="fas fa-share-alt"></i>
                  </button>
                  <button class="btn btn-sm btn-warning filter-btn text-white px-2" data-mayorista="${mayorista.id}" title="Filtrar">
                    <i class="fas fa-filter"></i>
                  </button>
                  <button class="btn btn-sm btn-danger clear-btn px-2" data-mayorista="${mayorista.id}" title="Limpiar">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="input-group input-group-sm" style="width: 60px;">
                  <input type="number" min="0" class="form-control form-control-sm p-1 text-start global-mayorista-input" 
                         data-mayorista="${mayorista.id}" value="0" placeholder="Cant." style="height: 24px; font-size: 0.75rem;">
                </div>
              </div>
            </div>
          </th>
        `;
      });
      
      html += '</tr></thead><tbody>';
      
      // Filas de datos
      recData.HR.forEach((row, rowIndex) => {
        const codigo = formatCellValue(row[0]);
        const color = formatCellValue(row[1]);
        const talla = formatCellValue(row[2]);
        const cantidad = parseFloat(row[3]) || 0;
        
        html += `<tr>`;
        html += `<td>${codigo}</td>`;
        html += `<td>${color}</td>`;
        html += `<td>${talla}</td>`;
        html += `<td>${cantidad}</td>`;
        
        // Valores para empresas
        empresasData.forEach(([id, config]) => {
          if (config.tipoEmpresa === "Principal") {
            html += `<td class="principal-cell" data-row="${rowIndex}">${cantidad}</td>`;
          } else {
            html += `<td class="secundaria-cell" data-row="${rowIndex}" data-empresa="${id}">0</td>`;
          }
        });
        
        // Inputs para mayoristas
        activeMayoristas.forEach(mayorista => {
          html += `
            <td>
              <input type="number" min="0" max="${cantidad}" 
                     class="mayorista-input" 
                     data-row="${rowIndex}" 
                     data-mayorista="${mayorista.id}"
                     value="0"
                     data-color="${color}"
                     data-talla="${talla}">
            </td>
          `;
        });
        
        html += '</tr>';
      });
      
      // Fila de totales
      html += '<tr class="total-row">';
      html += '<td colspan="3"><strong>Total</strong></td>';
      
      const totalCantidad = recData.HR.reduce((sum, row) => sum + (parseFloat(row[3]) || 0), 0);
      html += `<td><strong>${totalCantidad}</strong></td>`;
      
      // Totales empresas
      empresasData.forEach(([id, config]) => {
        if (config.tipoEmpresa === "Principal") {
          html += `<td><strong class="principal-total">${totalCantidad}</strong></td>`;
        } else {
          html += `<td><strong class="secundaria-total" data-empresa="${id}">0</strong></td>`;
        }
      });
      
      // Totales mayoristas
      activeMayoristas.forEach(mayorista => {
        html += `<td><strong class="mayorista-total" data-mayorista="${mayorista.id}">0</strong></td>`;
      });
      
      html += '</tr></tbody></table>';
      
      return html;
    }

    function attachInputEvents() {
      // Eventos para inputs de mayoristas
      document.querySelectorAll('.mayorista-input').forEach(input => {
        input.addEventListener('input', updateMayoristaInput);
      });
      
      // Eventos para inputs globales
      document.querySelectorAll('.global-mayorista-input').forEach(input => {
        input.addEventListener('input', updateGlobalMayoristaValue);
      });
      
      // Botones de distribución
      document.querySelectorAll('.distribute-btn').forEach(btn => {
        btn.addEventListener('click', distributeGlobalQuantity);
      });
      
      // Botones de limpieza
      document.querySelectorAll('.clear-btn').forEach(btn => {
        btn.addEventListener('click', clearMayoristaValues);
      });
      
      // Botones de filtro
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', openFilterModal);
      });
    }

    function updateGlobalMayoristaValue(event) {
      const input = event.target;
      const mayoristaId = input.dataset.mayorista;
      const value = parseInt(input.value) || 0;
      
      // Validar contra el total disponible
      const totalDisponible = currentRecData.HR.reduce((sum, row) => sum + (parseFloat(row[3]) || 0), 0);
      
      // Calcular ya asignado a otros mayoristas
      let assignedToOthers = 0;
      activeMayoristas.forEach(m => {
        if (m.id !== mayoristaId) {
          const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${m.id}"]`);
          assignedToOthers += parseInt(globalInput?.value) || 0;
        }
      });
      
      if (value + assignedToOthers > totalDisponible) {
        input.value = Math.max(0, totalDisponible - assignedToOthers);
      }
    }

    function clearMayoristaValues(event) {
      const btn = event.target.closest('.clear-btn');
      const mayoristaId = btn.dataset.mayorista;
      
      // Limpiar input global
      const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
      if (globalInput) globalInput.value = '0';
      
      // Limpiar inputs por fila
      document.querySelectorAll(`.mayorista-input[data-mayorista="${mayoristaId}"]`).forEach(input => {
        input.value = '0';
      });
      
      // Restablecer filtros
      if (mayoristaFilters[mayoristaId]) {
        mayoristaFilters[mayoristaId].excludedColors = [];
        mayoristaFilters[mayoristaId].excludedTallas = [];
      }
      
      updateAllValues();
    }

// Modifica la función openFilterModal - REEMPLAZA completamente esta función:
function openFilterModal(event) {
    const mayoristaId = event.currentTarget.dataset.mayorista;
    const mayorista = allConfigData[mayoristaId];
    
    if (!currentRecData || !currentRecData.HR || currentRecData.HR.length === 0) {
        alert('Primero busque un REC para configurar los filtros');
        return;
    }
    
    // Extraer opciones únicas de colores y tallas
    const colors = new Set();
    const tallas = new Set();
    
    currentRecData.HR.forEach(row => {
        if (row[1]) colors.add(row[1]);
        if (row[2]) tallas.add(row[2]);
    });
    
    colorOptions = Array.from(colors);
    tallaOptions = Array.from(tallas);
    
    // Asegurar estructura de filtros
    if (!mayoristaFilters[mayoristaId]) {
        mayoristaFilters[mayoristaId] = {
            excludedColors: [],
            excludedTallas: []
        };
    }
    
    // Crear modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    
    modal.innerHTML = `
        <div class="modal-content" style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 class="modal-title" style="font-size: 1.2rem; font-weight: 600; color: #3498db;">Filtros para ${mayorista.nombreCorto}</h3>
                <button class="close-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filter-section" style="margin-bottom: 20px;">
                    <h5>Excluir Colores</h5>
                    <div id="colorFilters-${mayoristaId}" class="filter-options" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;"></div>
                </div>
                <div class="filter-section" style="margin-bottom: 20px;">
                    <h5>Excluir Tallas</h5>
                    <div id="tallaFilters-${mayoristaId}" class="filter-options" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; margin-top: 10px;"></div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end;">
                <button class="btn btn-primary apply-filters" type="button" data-mayorista-id="${mayoristaId}" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    <i class="fas fa-check" style="margin-right: 8px;"></i>Aplicar Filtros
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Llenar opciones de colores
    const colorContainer = document.getElementById(`colorFilters-${mayoristaId}`);
    colorOptions.forEach(color => {
        const div = document.createElement('div');
        div.className = 'filter-option';
        div.style.cssText = 'display: flex; align-items: center; gap: 5px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `color-${mayoristaId}-${color}`;
        checkbox.value = color;
        checkbox.checked = mayoristaFilters[mayoristaId].excludedColors.includes(color);
        
        const label = document.createElement('label');
        label.htmlFor = `color-${mayoristaId}-${color}`;
        label.textContent = color;
        label.style.cssText = 'margin: 0; cursor: pointer;';
        
        div.appendChild(checkbox);
        div.appendChild(label);
        colorContainer.appendChild(div);
    });
    
    // Llenar opciones de tallas
    const tallaContainer = document.getElementById(`tallaFilters-${mayoristaId}`);
    tallaOptions.forEach(talla => {
        const div = document.createElement('div');
        div.className = 'filter-option';
        div.style.cssText = 'display: flex; align-items: center; gap: 5px;';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `talla-${mayoristaId}-${talla}`;
        checkbox.value = talla;
        checkbox.checked = mayoristaFilters[mayoristaId].excludedTallas.includes(talla);
        
        const label = document.createElement('label');
        label.htmlFor = `talla-${mayoristaId}-${talla}`;
        label.textContent = talla;
        label.style.cssText = 'margin: 0; cursor: pointer;';
        
        div.appendChild(checkbox);
        div.appendChild(label);
        tallaContainer.appendChild(div);
    });
    
    // Mostrar modal
    showModal(modal);
    
    // Eventos del modal
    modal.querySelector('.close-modal').addEventListener('click', () => {
        hideModal(modal);
        setTimeout(() => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        }, 300);
    });
    
    modal.querySelector('.apply-filters').addEventListener('click', (e) => {
        const mayoristaId = e.currentTarget.dataset.mayoristaId;
        
        // Guardar filtros
        mayoristaFilters[mayoristaId].excludedColors = Array.from(
            document.querySelectorAll(`#colorFilters-${mayoristaId} input[type="checkbox"]:checked`)
        ).map(cb => cb.value);
        
        mayoristaFilters[mayoristaId].excludedTallas = Array.from(
            document.querySelectorAll(`#tallaFilters-${mayoristaId} input[type="checkbox"]:checked`)
        ).map(cb => cb.value);
        
        hideModal(modal);
        setTimeout(() => {
            if (document.body.contains(modal)) {
                document.body.removeChild(modal);
            }
        }, 300);
        
        // Si hay valor global, redistribuir
        const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
        const valorGlobal = parseInt(globalInput?.value) || 0;
        
        if (valorGlobal > 0) {
            const distributeBtn = document.querySelector(`.distribute-btn[data-mayorista="${mayoristaId}"]`);
            if (distributeBtn) {
                distributeBtn.click();
            }
        }
    });
    
    // Cerrar modal al hacer clic fuera
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal(modal);
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            }, 300);
        }
    });
}

    function formatCellValue(value) {
      if (value == null) return '';
      if (Array.isArray(value)) return value.join(', ');
      if (typeof value === 'object') return JSON.stringify(value);
      return String(value);
    }
    
    function handleError(error) {
      console.error("Error:", error);
      document.getElementById('loading').innerHTML = `
        <div class="alert alert-danger">
          Error cargando datos: ${error.message}<br>
          <button class="btn btn-primary mt-2" onclick="initialize()">Reintentar</button>
        </div>
      `;
    }
    
    function reloadAllData() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('loading').innerHTML = `
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <span>Actualizando datos...</span>
      `;
      document.getElementById('result').innerHTML = '';
      initialize();
    }

    // Funciones de distribución inteligente
    function smartDistribution(availableRows, totalQty) {
      const totalAvailable = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      const uniqueItems = availableRows.length;
      const scenario = classifyScenario(totalQty, uniqueItems, totalAvailable);
      
      switch(scenario) {
        case 'LOW_QUANTITY': return distributeLowQuantity(availableRows, totalQty);
        case 'BALANCED': return distributeBalanced(availableRows, totalQty);
        case 'HIGH_QUANTITY': return distributeHighQuantity(availableRows, totalQty);
        case 'LIMITED_STOCK': return distributeLimitedStock(availableRows, totalQty);
        default: return distributeDefault(availableRows, totalQty);
      }
    }
    
    function classifyScenario(totalQty, uniqueItems, totalAvailable) {
      const avgPerItem = totalQty / uniqueItems;
      const stockRatio = totalQty / totalAvailable;
      
      if (totalQty <= uniqueItems) return 'LOW_QUANTITY';
      else if (avgPerItem < 3 && stockRatio < 0.3) return 'BALANCED';
      else if (stockRatio > 0.7) return 'HIGH_QUANTITY';
      else if (totalAvailable / uniqueItems < 2) return 'LIMITED_STOCK';
      return 'DEFAULT';
    }
    
    function distributeLowQuantity(availableRows, totalQty) {
      const prioritized = [...availableRows].sort((a, b) => {
        const priorityA = (a.tdm * 0.7) + (a.historicRotation * 0.3);
        const priorityB = (b.tdm * 0.7) + (b.historicRotation * 0.3);
        return priorityB - priorityA;
      });
      
      return prioritized.map((row, index) => ({
        ...row,
        assigned: index < totalQty ? 1 : 0
      })).filter(row => row.assigned > 0);
    }
    
    function distributeBalanced(availableRows, totalQty) {
      const basePerItem = Math.floor(totalQty / availableRows.length);
      let remaining = totalQty - (basePerItem * availableRows.length);
      
      let distributed = availableRows.map(row => {
        const assigned = Math.min(basePerItem, row.tdm);
        return { ...row, assigned };
      });
      
      if (remaining > 0) {
        distributed.sort((a, b) => (b.tdm - b.assigned) - (a.tdm - a.assigned));
        
        for (let i = 0; i < distributed.length && remaining > 0; i++) {
          const available = distributed[i].tdm - distributed[i].assigned;
          if (available > 0) {
            distributed[i].assigned += 1;
            remaining -= 1;
          }
        }
      }
      
      return distributed;
    }
    
    function distributeHighQuantity(availableRows, totalQty) {
      const totalStock = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      let remaining = totalQty;
      
      let distributed = availableRows.map(row => {
        const proportion = row.tdm / totalStock;
        let assigned = Math.max(1, Math.floor(proportion * totalQty));
        assigned = Math.min(assigned, row.tdm);
        remaining -= assigned;
        return { ...row, assigned };
      });
      
      if (remaining !== 0) {
        distributed.sort((a, b) => {
          const deviationA = (a.assigned / a.tdm) - (totalQty / totalStock);
          const deviationB = (b.assigned / b.tdm) - (totalQty / totalStock);
          return Math.abs(deviationB) - Math.abs(deviationA);
        });
        
        for (let i = 0; i < distributed.length && remaining !== 0; i++) {
          const row = distributed[i];
          const canAdd = remaining > 0 ? row.tdm - row.assigned : row.assigned;
          
          if (canAdd > 0) {
            const adjustment = remaining > 0 ? 1 : -1;
            row.assigned += adjustment;
            remaining -= adjustment;
          }
        }
      }
      
      return distributed;
    }
    
    function distributeLimitedStock(availableRows, totalQty) {
      const totalStock = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      let remaining = totalQty;
      
      let distributed = availableRows.map(row => {
        let assigned = Math.min(1, row.tdm);
        remaining -= assigned;
        return { ...row, assigned };
      });
      
      if (remaining > 0) {
        const remainingStock = totalStock - availableRows.length;
        distributed.forEach(row => {
          if (remaining <= 0) return;
          
          const additional = Math.min(
            Math.floor((row.tdm - 1) / remainingStock * remaining),
            row.tdm - row.assigned
          );
          
          if (additional > 0) {
            row.assigned += additional;
            remaining -= additional;
          }
        });
      }
      
      if (remaining > 0) {
        distributed.sort((a, b) => b.tdm - a.tdm);
        for (let i = 0; i < distributed.length && remaining > 0; i++) {
          const available = distributed[i].tdm - distributed[i].assigned;
          if (available > 0) {
            const toAdd = Math.min(available, remaining);
            distributed[i].assigned += toAdd;
            remaining -= toAdd;
          }
        }
      }
      
      return distributed;
    }
    
    function distributeDefault(availableRows, totalQty) {
      const totalStock = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      let remaining = totalQty;
      
      let distributed = availableRows.map(row => {
        const proportion = row.tdm / totalStock;
        let assigned = Math.floor(proportion * totalQty);
        assigned = Math.min(assigned, row.tdm);
        remaining -= assigned;
        return { ...row, assigned };
      });
      
      if (remaining > 0) {
        distributed.sort((a, b) => (b.tdm - b.assigned) - (a.tdm - a.assigned));
        
        for (let i = 0; i < distributed.length && remaining > 0; i++) {
          const available = distributed[i].tdm - distributed[i].assigned;
          if (available > 0) {
            distributed[i].assigned += 1;
            remaining -= 1;
          }
        }
      }
      
      return distributed;
    }

    // Función placeholder para guardar
    function saveAllDistributionsFast() {
      Swal.fire({
        icon: 'info',
        title: 'Función de Guardar',
        text: 'La función de guardar no está implementada en esta versión',
        confirmButtonText: 'Entendido'
      });
    }

    function confirmarCambio() {
      Swal.fire({
        title: '¿Estás seguro?',
        text: "Esta función requiere Google Apps Script para funcionar",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Entendido',
        cancelButtonText: 'Cancelar'
      });
    }

// Función para mostrar el modal
function showModal(modal) {
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
}

// Función para ocultar el modal
function hideModal(modal) {
    modal.style.opacity = '0';
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}




    // Inicializar la aplicación
    window.addEventListener('DOMContentLoaded', initialize);

    // Atajo de teclado Ctrl+Q
    document.addEventListener('keydown', function(event) {
      if ((event.ctrlKey || event.metaKey) && (event.key === 'q' || event.key === 'Q')) {
        event.preventDefault();
        saveAllDistributionsFast();
      }
    });
  </script>
</body>
</html>