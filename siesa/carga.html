<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador SIESA</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        
        .loading {
            background-color: #fff9c4;
            color: #f57c00;
        }
        
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .json-view {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Visualizador de Datos SIESA</h1>
    
    <div class="container">
        <div class="controls">
            <button id="downloadJson" disabled>Descargar JSON</button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="jsonView" class="json-view"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const downloadJsonBtn = document.getElementById('downloadJson');
            const statusDiv = document.getElementById('status');
            const jsonViewDiv = document.getElementById('jsonView');
            
            let processedData = [];
            let groupedData = [];
            let startTime = 0;
            
            // Mapeo de nombres SIESA a NITs unificados
            const MAPEO_NOMBRES_SIESA = {
                "ARISTIZABAL LOPEZ JESUS MARIA": "70825517",
                "EL TEMPLO DE LA MODA FRESCA S.A.S.": "900047252",
                "EL TEMPLO DE LA MODA FRESCA SAS": "900047252",
                "EL TEMPLO DE LA MODA S.A.S.": "805027653",
                "EL TEMPLO DE LA MODA SAS": "805027653",
                "INVERSIONES URBANA S.A.S": "901920844",
                "INVERSIONES URBANA SAS": "901920844",
                "QUINTERO ORTIZ JOSE ALEXANDER": "14838951",
                "QUINTERO ORTIZ PATRICIA YAMILET": "67006141",
                "ZULUAGA GOMEZ RUBEN ESTEBAN": "1007348825",
            };
            
            // Mapeo de prefijos a tipos de documento
            const MAPEO_PREFIJOS_TIPO = {
                "017": "REMISIONES",
                "029": "REMISIONES",
                "008": "DEVOLUCIONES",
                "034": "DEVOLUCIONES",
                "FEV": "OFICIALES",
                "FVE": "OFICIALES",
                "NEC": "NOTA_CREDITO"
            };
            
            // Tipos de documentos permitidos
            const TIPOS_PERMITIDOS = ["OFICIALES", "REMISIONES"];
            
            // Función para mostrar estado
            function showStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = 'status ' + type;
            }
            
            // Función para normalizar fecha
            function normalizarFecha(fechaStr) {
                if (!fechaStr) return null;
                
                const partes = fechaStr.split('/');
                if (partes.length !== 3) return fechaStr;
                
                const mes = partes[0].padStart(2, '0');
                const dia = partes[1].padStart(2, '0');
                const año = partes[2];
                
                return `${año}-${mes}-${dia}`;
            }
            
            // Función para normalizar número
            function normalizarNumero(numeroStr) {
                if (!numeroStr) return null;
                const numeroLimpio = numeroStr.toString().replace(/\s+/g, '').replace(/[^\d.-]/g, '');
                const numero = parseFloat(numeroLimpio);
                return isNaN(numero) ? null : numero;
            }
            
            // Función para obtener el tipo de documento
            function obtenerTipoDocumento(nroDocumento) {
                if (!nroDocumento) return null;
                
                const partes = nroDocumento.split('-');
                if (partes.length < 2) return null;
                
                const prefijo = partes[0].toUpperCase();
                return MAPEO_PREFIJOS_TIPO[prefijo] || null;
            }
            
            // Función para obtener NIT y nombre unificado
            function obtenerClienteUnificado(razonSocial) {
                const nombreUpper = razonSocial.toUpperCase().trim();
                for (const [nombreMapeado, nit] of Object.entries(MAPEO_NOMBRES_SIESA)) {
                    if (nombreUpper === nombreMapeado.toUpperCase()) {
                        return { razonSocial: nombreMapeado, nit: nit };
                    }
                }
                return null;
            }
            
            // Función para obtener nombre de compañía
            function obtenerNombreCompania(codigoCompania) {
                if (codigoCompania === '3') return "TEXTILES Y CREACIONES LOS ANGELES SAS";
                if (codigoCompania === '5') return "TEXTILES Y CREACIONES EL UNIVERSO SAS";
                return null;
            }
            
            // Función para obtener lote según compañía
            function obtenerLote(compania, fila) {
                if (compania === '5') return normalizarNumero(fila[4]); // Docto. referencia
                if (compania === '3') return normalizarNumero(fila[5]); // Notas
                return null;
            }
            
            // Función para procesar datos de SIESA_V2
            function procesarDatosV2(datosV2) {
                const datosAgrupados = {};
                
                if (!datosV2 || datosV2.length < 2) return datosAgrupados;
                
                for (let i = 1; i < datosV2.length; i++) {
                    const fila = datosV2[i];
                    if (fila.length < 4) continue;
                    
                    const documento = fila[0] || '';
                    const valorSubtotal = normalizarNumero(fila[1]);
                    const referencia = fila[2] || '';
                    const cantidad = normalizarNumero(fila[3]);
                    
                    if (!documento) continue;
                    
                    if (!datosAgrupados[documento]) {
                        datosAgrupados[documento] = {
                            valorSubtotal: 0,
                            cantidad: 0,
                            referencias: new Set()
                        };
                    }
                    
                    if (valorSubtotal !== null) datosAgrupados[documento].valorSubtotal += valorSubtotal;
                    if (cantidad !== null) datosAgrupados[documento].cantidad += cantidad;
                    if (referencia) datosAgrupados[documento].referencias.add(referencia);
                }
                
                return datosAgrupados;
            }
            
            // Función para procesar datos de SOPORTES
            function procesarDatosSoportes(datosSoportes) {
                const datosSoportesMap = {};
                
                if (!datosSoportes || datosSoportes.length < 2) return datosSoportesMap;
                
                for (let i = 1; i < datosSoportes.length; i++) {
                    const fila = datosSoportes[i];
                    if (fila.length < 9) continue;
                    
                    const factura = fila[5] || ''; // Factura - índice 5
                    const urlIh3 = fila[8] || '';  // Url_Ih3 - índice 8
                    
                    if (factura) {
                        datosSoportesMap[factura] = urlIh3;
                    }
                }
                
                return datosSoportesMap;
            }
            
            // Función para agrupar datos por lote
            function agruparPorLote(datos) {
                const agrupados = {};
                
                datos.forEach(item => {
                    const lote = item.lote;
                    if (!lote) return;
                    
                    if (!agrupados[lote]) {
                        agrupados[lote] = {
                            documento: "REC" + lote,
                            referencia: "",
                            lote: lote,
                            datosSiesa: []
                        };
                    }
                    
                    agrupados[lote].datosSiesa.push({
                        estado: item.estado,
                        factura: item.factura,
                        fecha: item.fecha,
                        lote: item.lote.toString(),
                        proovedor: item.proveedor,
                        cliente: item.cliente,
                        valorBruto: item.valor,
                        refprov: item.refprov,
                        cantidad: item.cantidad,
                        nit: item.nit,
                        confirmacion: item.confirmacion,
                        soporte: item.soporte
                    });
                });
                
                return Object.values(agrupados);
            }
            
            // Función para cargar datos desde Google Sheets
            async function cargarDatos() {
                startTime = Date.now();
                showStatus('Cargando datos...', 'loading');
                
                try {
                    const apiKey = 'AIzaSyC7hjbRc0TGLgImv8gVZg8tsOeYWgXlPcM';
                    
                    // Cargar datos de SIESA
                    const spreadsheetIdSiesa = '1FcQhVIKtWy4O-aGTNfA6l4C5Q4_u1LZErpj3CMglfQM';
                    const urlSiesa = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetIdSiesa}/values/SIESA?key=${apiKey}`;
                    const responseSiesa = await fetch(urlSiesa);
                    
                    if (!responseSiesa.ok) throw new Error(`Error SIESA: ${responseSiesa.status}`);
                    
                    const dataSiesa = await responseSiesa.json();
                    if (!dataSiesa.values || dataSiesa.values.length === 0) {
                        throw new Error('No hay datos en SIESA');
                    }
                    
                    // Cargar datos de SIESA_V2
                    const urlSiesaV2 = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetIdSiesa}/values/SIESA_V2?key=${apiKey}`;
                    const responseSiesaV2 = await fetch(urlSiesaV2);
                    
                    let datosV2 = null;
                    if (responseSiesaV2.ok) {
                        const dataSiesaV2 = await responseSiesaV2.json();
                        datosV2 = dataSiesaV2.values || [];
                    }
                    
                    // Cargar datos de SOPORTES
                    const spreadsheetIdSoportes = '1VaPBwgRu1QWhmsV_Qgf7cgraSxiAWRX6-wBEyUlGoJw';
                    const urlSoportes = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetIdSoportes}/values/SOPORTES?key=${apiKey}`;
                    const responseSoportes = await fetch(urlSoportes);
                    
                    let datosSoportes = null;
                    if (responseSoportes.ok) {
                        const dataSoportes = await responseSoportes.json();
                        datosSoportes = dataSoportes.values || [];
                    }
                    
                    // Procesar datos
                    procesarDatos(dataSiesa.values, datosV2, datosSoportes);
                    
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            }
            
            // Función para procesar datos
            function procesarDatos(datosSiesa, datosV2, datosSoportes) {
                if (datosSiesa.length < 2) {
                    showStatus('No hay datos suficientes', 'error');
                    return;
                }
                
                const datosV2Procesados = procesarDatosV2(datosV2);
                const datosSoportesProcesados = procesarDatosSoportes(datosSoportes);
                
                processedData = [];
                
                for (let i = 1; i < datosSiesa.length; i++) {
                    const fila = datosSiesa[i];
                    if (fila.length < 7) continue;
                    
                    const estado = fila[0];
                    const razonSocial = fila[3];
                    
                    if (estado === 'Aprobadas') {
                        const clienteUnificado = obtenerClienteUnificado(razonSocial);
                        
                        if (clienteUnificado) {
                            const nroDocumento = fila[1] || '';
                            const fecha = normalizarFecha(fila[2]);
                            const compania = fila[6] || '';
                            const tipo = obtenerTipoDocumento(nroDocumento);
                            const lote = obtenerLote(compania, fila);
                            const nombreCompania = obtenerNombreCompania(compania);
                            
                            const datosV2Documento = datosV2Procesados[nroDocumento] || {};
                            const referencias = Array.from(datosV2Documento.referencias || []);
                            let refprov = null;
                            
                            if (referencias.length === 1) refprov = referencias[0];
                            else if (referencias.length > 1) refprov = 'RefVar';
                            
                            const soporte = datosSoportesProcesados[nroDocumento] || '';
                            const confirmacion = soporte ? "ENTREGADO" : "PENDIENTE";
                            
                            if (lote !== null) {
                                processedData.push({
                                    estado: estado,
                                    factura: nroDocumento,
                                    fecha: fecha,
                                    cliente: clienteUnificado.razonSocial,
                                    proveedor: nombreCompania,
                                    nit: clienteUnificado.nit,
                                    lote: lote,
                                    tipo: tipo,
                                    valor: datosV2Documento.valorSubtotal || null,
                                    cantidad: datosV2Documento.cantidad || null,
                                    refprov: refprov,
                                    soporte: soporte,
                                    confirmacion: confirmacion
                                });
                            }
                        }
                    }
                }
                
                const filteredData = processedData.filter(item => TIPOS_PERMITIDOS.includes(item.tipo));
                groupedData = agruparPorLote(filteredData);
                
                const endTime = Date.now();
                const tiempoTotal = ((endTime - startTime) / 1000).toFixed(2);
                const totalDocumentos = filteredData.length;
                const totalLotes = groupedData.length;
                
                mostrarJSON(groupedData);
                showStatus(`Datos Cargados en ${tiempoTotal} segundos | ${totalLotes} lotes | ${totalDocumentos} documentos`, 'success');
                downloadJsonBtn.disabled = false;
            }
            
            // Función para mostrar JSON
            function mostrarJSON(datos) {
                jsonViewDiv.textContent = JSON.stringify(datos, null, 2);
            }
            
            // Función para descargar JSON
            function descargarJSON() {
                if (groupedData.length === 0) {
                    showStatus('No hay datos para descargar', 'error');
                    return;
                }
                
                const jsonStr = JSON.stringify(groupedData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'datos_siesa_agrupados.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('JSON descargado', 'success');
            }
            
            // Event listeners
            downloadJsonBtn.addEventListener('click', descargarJSON);
            
            // Cargar datos automáticamente
            cargarDatos();
        });
    </script>
</body>
</html>