<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Probador de Notificaciones PWA - Diagn√≥stico</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { max-width: 600px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; font-size: 1.3rem; }
        button { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: opacity 0.2s; }
        button:hover { opacity: 0.8; }
        .primary { background: #4285f4; color: white; }
        .secondary { background: #34a853; color: white; }
        .danger { background: #ea4335; color: white; }
        .info { background: #fbbc05; color: black; }
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .status { background: #e8f0fe; padding: 10px; border-radius: 8px; margin: 10px 0; white-space: pre-wrap; word-break: break-word; max-height: 200px; overflow-y: auto; }
        .flex { display: flex; gap: 10px; }
        .flex button { margin: 0; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-left: 8px; }
        .badge.success { background: #34a853; color: white; }
        .badge.error { background: #ea4335; color: white; }
        .badge.warning { background: #fbbc05; color: black; }
        .diagnostic-item { padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 0.9rem; }
        .success { color: #34a853; }
        .error { color: #ea4335; }
        .warning { color: #fbbc05; }
    </style>
</head>
<body>
    <h1>üì± Probador de Notificaciones Push v2</h1>
    
    <!-- Tarjeta de Diagn√≥stico R√°pido -->
    <div class="card">
        <h2>üîß Diagn√≥stico de Conexi√≥n</h2>
        <div id="diagnosticStatus" class="status">Ejecutando diagn√≥stico...</div>
        <button id="runDiagnostic" class="primary">üîÑ Ejecutar Diagn√≥stico Completo</button>
        <div id="diagnosticDetails"></div>
    </div>

    <!-- Configuraci√≥n de Endpoint -->
    <div class="card">
        <h2>‚öôÔ∏è Configuraci√≥n API</h2>
        <label>URL del Endpoint GAS:</label>
        <input type="url" id="apiUrl" value="https://script.google.com/macros/s/AKfycbyK1miSWu81LzaoIiIchNsZtXsFtZshf9U8Z9goZovzd7kmx8mStvcpCYIJZspNQVhI/exec" placeholder="URL de Google Apps Script">
        <select id="corsMode">
            <option value="cors">CORS (recomendado)</option>
            <option value="no-cors">no-cors (solo lectura)</option>
        </select>
        <button id="testCors" class="info">üåê Probar CORS</button>
    </div>

    <!-- Tarjeta: Estado y Registro -->
    <div class="card">
        <h2>üîß Service Worker</h2>
        <div id="swStatus" class="status">Verificando...</div>
        <button id="registerSw" class="primary">üìå Registrar SW</button>
        <button id="unregisterSw" class="danger">üóëÔ∏è Desregistrar SW</button>
    </div>

    <!-- Tarjeta: Suscripci√≥n Push -->
    <div class="card">
        <h2>üîî Suscripci√≥n Push</h2>
        <div id="pushStatus" class="status">No suscrito</div>
        <div class="flex">
            <button id="subscribe" class="secondary">‚úÖ Suscribirse</button>
            <button id="unsubscribe" class="danger">‚ùå Desuscribirse</button>
        </div>
        <button id="checkSubscription" class="info">üîÑ Verificar</button>
    </div>

    <!-- Tarjeta: Env√≠o Personalizado -->
    <div class="card">
        <h2>‚úâÔ∏è Enviar Notificaci√≥n</h2>
        <input type="text" id="notifTitle" placeholder="T√≠tulo" value="Notificaci√≥n de prueba">
        <textarea id="notifBody" placeholder="Mensaje" rows="3">Este es un mensaje de prueba</textarea>
        <input type="text" id="notifIcon" placeholder="URL del √≠cono" value="">
        <button id="sendNotification" class="primary">üöÄ ENVIAR</button>
    </div>

    <!-- Tarjeta: Logs Detallados -->
    <div class="card">
        <h2>üìã Logs <span id="logBadge" class="badge">0</span></h2>
        <div id="logContainer" class="status"></div>
        <button id="clearLogs" class="info">üßπ Limpiar</button>
        <button id="copyLogs" class="info">üìã Copiar logs</button>
    </div>

    <script>
        // Configuraci√≥n por defecto
        let API_URL = document.getElementById('apiUrl').value;
        let swRegistration = null;

        // Funci√≥n de logging mejorada
        function addLog(message, type = 'info', data = null) {
            const logContainer = document.getElementById('logContainer');
            const logBadge = document.getElementById('logBadge');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.style.padding = '8px 4px';
            logEntry.style.borderBottom = '1px solid #eee';
            logEntry.style.color = type === 'error' ? '#ea4335' : 
                                   type === 'success' ? '#34a853' : 
                                   type === 'warning' ? '#fbbc05' : '#333';
            
            let logText = `[${timestamp}] ${message}`;
            if (data) {
                logText += `\nüì¶ Datos: ${JSON.stringify(data, null, 2).substring(0, 200)}`;
            }
            
            logEntry.textContent = logText;
            logEntry.style.whiteSpace = 'pre-wrap';
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            const logs = logContainer.children.length;
            logBadge.textContent = logs;
            logBadge.className = `badge ${type}`;
            
            console.log(`[${type}] ${message}`, data || '');
        }

        // Fetch con manejo de errores mejorado
        async function safeFetch(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 segundos timeout
            
            try {
                addLog(`üåê Fetching: ${url.substring(0, 100)}...`, 'info');
                
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal,
                    mode: document.getElementById('corsMode').value,
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // GAS espera texto plano
                        ...options.headers
                    }
                });
                
                clearTimeout(timeoutId);
                
                addLog(`üì• Respuesta status: ${response.status} ${response.statusText}`, 
                       response.ok ? 'success' : 'warning');
                
                // Intentar obtener el texto de la respuesta
                const text = await response.text();
                addLog(`üìÑ Respuesta (primeros 200 chars): ${text.substring(0, 200)}`, 'info');
                
                // Intentar parsear JSON si es posible
                try {
                    const json = JSON.parse(text);
                    return { ok: response.ok, status: response.status, data: json, raw: text };
                } catch {
                    return { ok: response.ok, status: response.status, data: text, raw: text };
                }
                
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    addLog('‚è±Ô∏è Timeout: La petici√≥n tard√≥ demasiado', 'error');
                } else {
                    addLog(`‚ùå Fetch error: ${err.message}`, 'error');
                }
                throw err;
            }
        }

        // Diagn√≥stico completo
        async function runDiagnostic() {
            const diagnosticDiv = document.getElementById('diagnosticDetails');
            diagnosticDiv.innerHTML = '';
            addLog('üîç Iniciando diagn√≥stico...', 'info');
            
            // 1. Verificar navegador
            addDiagnosticItem('Navegador', navigator.userAgent);
            
            // 2. Verificar Service Worker
            const swSupported = 'serviceWorker' in navigator;
            addDiagnosticItem('Service Worker soportado', swSupported ? '‚úÖ S√≠' : '‚ùå No', swSupported);
            
            // 3. Verificar Push API
            const pushSupported = 'PushManager' in window;
            addDiagnosticItem('Push API soportada', pushSupported ? '‚úÖ S√≠' : '‚ùå No', pushSupported);
            
            // 4. Verificar URL
            addDiagnosticItem('API URL', API_URL);
            
            // 5. Probar GET simple
            try {
                const result = await safeFetch(`${API_URL}?action=test`);
                addDiagnosticItem('GET test', `‚úÖ OK (${result.status})`, true);
            } catch (err) {
                addDiagnosticItem('GET test', `‚ùå Error: ${err.message}`, false);
            }
            
            // 6. Probar OPTIONS (CORS)
            try {
                const response = await fetch(API_URL, { method: 'OPTIONS' });
                addDiagnosticItem('CORS preflight', `‚úÖ OK (${response.status})`, true);
            } catch (err) {
                addDiagnosticItem('CORS preflight', `‚ùå ${err.message}`, false);
            }
            
            // 7. Verificar SSL
            addDiagnosticItem('HTTPS', window.location.protocol === 'https:' ? '‚úÖ S√≠' : '‚ùå No (requerido para SW)', window.location.protocol === 'https:');
            
            addLog('‚úÖ Diagn√≥stico completado', 'success');
        }

        function addDiagnosticItem(label, value, isOk = null) {
            const div = document.getElementById('diagnosticDetails');
            const item = document.createElement('div');
            item.className = 'diagnostic-item';
            
            let color = '#333';
            if (isOk === true) color = '#34a853';
            if (isOk === false) color = '#ea4335';
            
            item.innerHTML = `<strong>${label}:</strong> <span style="color: ${color}">${value}</span>`;
            div.appendChild(item);
        }

        // Probar CORS espec√≠ficamente
        async function testCors() {
            try {
                addLog('üåê Probando CORS...', 'info');
                
                // Prueba con GET simple
                const response = await fetch(`${API_URL}?action=test`, {
                    mode: 'cors',
                    headers: { 'Content-Type': 'text/plain' }
                });
                
                const text = await response.text();
                addLog('‚úÖ CORS funciona correctamente', 'success');
                addLog(`Respuesta: ${text.substring(0, 100)}`, 'info');
                
            } catch (err) {
                addLog(`‚ùå Error CORS: ${err.message}`, 'error');
                addLog('üí° Soluci√≥n: Publica el script GAS como "Ejecutarse como: Yo" y "Acceso: Cualquier persona"', 'warning');
            }
        }

        // Verificar suscripci√≥n push
        async function checkPushSubscription() {
            if (!swRegistration) {
                swRegistration = await navigator.serviceWorker.ready;
            }
            const subscription = await swRegistration.pushManager.getSubscription();
            if (subscription) {
                document.getElementById('pushStatus').textContent = '‚úÖ Suscripci√≥n activa';
                addLog('Suscripci√≥n encontrada', 'success');
                return subscription;
            } else {
                document.getElementById('pushStatus').textContent = '‚ùå No hay suscripci√≥n';
                return null;
            }
        }

        // Event Listeners
        document.getElementById('runDiagnostic').addEventListener('click', runDiagnostic);
        document.getElementById('testCors').addEventListener('click', testCors);
        
        document.getElementById('apiUrl').addEventListener('change', (e) => {
            API_URL = e.target.value;
            addLog(`URL actualizada: ${API_URL}`, 'info');
        });

        document.getElementById('registerSw').addEventListener('click', async () => {
            try {
                addLog('Registrando Service Worker...');
                if ('serviceWorker' in navigator) {
                    swRegistration = await navigator.serviceWorker.register('sw.js', { scope: './' });
                    document.getElementById('swStatus').textContent = '‚úÖ SW registrado';
                    addLog('SW registrado exitosamente', 'success');
                    
                    // Verificar suscripci√≥n existente
                    await checkPushSubscription();
                }
            } catch (err) {
                document.getElementById('swStatus').textContent = `‚ùå ${err.message}`;
                addLog(`Error SW: ${err.message}`, 'error');
            }
        });

        document.getElementById('unregisterSw').addEventListener('click', async () => {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let reg of registrations) {
                    await reg.unregister();
                }
                document.getElementById('swStatus').textContent = '‚ùå SW desregistrado';
                addLog('SW desregistrado', 'success');
            } catch (err) {
                addLog(`Error: ${err.message}`, 'error');
            }
        });

        document.getElementById('subscribe').addEventListener('click', async () => {
            try {
                if (!swRegistration) {
                    swRegistration = await navigator.serviceWorker.ready;
                }

                // Obtener clave VAPID
                addLog('Obteniendo clave VAPID...');
                const vapidResult = await safeFetch(`${API_URL}?action=vapid-public-key`);
                
                if (!vapidResult.ok) throw new Error('No se pudo obtener clave VAPID');
                
                const vapidKey = vapidResult.data;
                addLog('Clave VAPID obtenida', 'success');

                // Convertir clave
                const convertedKey = urlBase64ToUint8Array(vapidKey);
                
                // Suscribir
                addLog('Suscribiendo a push...');
                const subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: convertedKey
                });

                // Enviar al servidor
                addLog('Enviando suscripci√≥n al servidor...');
                const subData = {
                    action: 'subscribe',
                    subscription: subscription.toJSON()
                };

                const result = await safeFetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(subData)
                });

                if (result.ok) {
                    document.getElementById('pushStatus').textContent = '‚úÖ Suscrito';
                    addLog('Suscripci√≥n guardada', 'success', result.data);
                } else {
                    throw new Error('Error en servidor');
                }

            } catch (err) {
                document.getElementById('pushStatus').textContent = `‚ùå ${err.message}`;
                addLog(`Error suscripci√≥n: ${err.message}`, 'error');
            }
        });

        document.getElementById('unsubscribe').addEventListener('click', async () => {
            try {
                const subscription = await checkPushSubscription();
                if (subscription) {
                    const endpoint = subscription.endpoint;
                    await subscription.unsubscribe();
                    
                    const result = await safeFetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'unsubscribe',
                            endpoint: endpoint
                        })
                    });
                    
                    document.getElementById('pushStatus').textContent = '‚ùå Desuscrito';
                    addLog('Desuscripci√≥n exitosa', 'success');
                }
            } catch (err) {
                addLog(`Error: ${err.message}`, 'error');
            }
        });

        document.getElementById('checkSubscription').addEventListener('click', checkPushSubscription);

        document.getElementById('sendNotification').addEventListener('click', async () => {
            try {
                const title = document.getElementById('notifTitle').value;
                const body = document.getElementById('notifBody').value;
                const icon = document.getElementById('notifIcon').value;
                
                addLog(`Enviando: "${title}"...`);
                
                const result = await safeFetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'send-notification',
                        title: title,
                        body: body,
                        icon: icon
                    })
                });

                if (result.ok) {
                    addLog('‚úÖ Notificaci√≥n enviada', 'success', result.data);
                } else {
                    addLog('‚ùå Error en env√≠o', 'error', result.data);
                }

            } catch (err) {
                addLog(`Error: ${err.message}`, 'error');
            }
        });

        document.getElementById('clearLogs').addEventListener('click', () => {
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('logBadge').textContent = '0';
        });

        document.getElementById('copyLogs').addEventListener('click', () => {
            const logs = document.getElementById('logContainer').innerText;
            navigator.clipboard.writeText(logs);
            addLog('Logs copiados al portapapeles', 'success');
        });

        // Utilidad Base64
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Inicializaci√≥n
        window.addEventListener('load', async () => {
            addLog('üöÄ App iniciada', 'success');
            await runDiagnostic();
        });
    </script>
</body>
</html>