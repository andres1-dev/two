<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemma 3n E4B Â· Professional</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Highlight.js para cÃ³digo -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- Marked para markdown -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <!-- KaTeX para matemÃ¡ticas -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #1e293b;
        }

        .app {
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            background: white;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Header profesional */
        .header {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e9eef2;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .model {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .model-icon {
            width: 36px;
            height: 36px;
            background: #2563eb;
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .model-name {
            font-weight: 600;
            font-size: 16px;
            color: #0f172a;
        }

        .model-badge {
            background: #e6f0ff;
            color: #2563eb;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .config-btn {
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .config-btn:hover {
            border-color: #2563eb;
            color: #2563eb;
            background: #f8fafc;
        }

        /* Modal de configuraciÃ³n */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 520px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e9eef2;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-header h3 i {
            color: #2563eb;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 18px;
        }

        .modal-close:hover {
            color: #2563eb;
        }

        .modal-body {
            padding: 24px;
        }

        .config-group {
            margin-bottom: 24px;
        }

        .config-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #334155;
            margin-bottom: 12px;
        }

        .config-group label i {
            width: 18px;
            color: #2563eb;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            -webkit-appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #2563eb;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
        }

        .slider-value {
            min-width: 45px;
            color: #2563eb;
            font-size: 13px;
            font-weight: 600;
        }

        .select-config {
            width: 100%;
            padding: 10px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #1e293b;
            font-size: 13px;
            outline: none;
        }

        .select-config:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e9eef2;
        }

        .preset-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #475569;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .preset-btn.active {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
        }

        .preset-btn i {
            font-size: 12px;
        }

        /* Messages area */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: #f8fafc;
        }

        .message {
            display: flex;
            gap: 14px;
            max-width: 85%;
        }

        .message.user {
            margin-left: auto;
        }

        .avatar {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569;
            flex-shrink: 0;
            font-size: 14px;
        }

        .message.user .avatar {
            background: #2563eb;
            color: white;
        }

        .bubble {
            background: white;
            padding: 16px 20px;
            border-radius: 14px;
            border-top-left-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            color: #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            border: 1px solid #edf2f7;
        }

        .message.user .bubble {
            background: #2563eb;
            color: white;
            border-top-left-radius: 14px;
            border-top-right-radius: 4px;
        }

        /* Formato de respuestas profesional */
        .bubble h1, .bubble h2, .bubble h3, .bubble h4 {
            margin: 16px 0 8px;
            color: #0f172a;
            font-weight: 600;
        }

        .message.user .bubble h1,
        .message.user .bubble h2,
        .message.user .bubble h3,
        .message.user .bubble h4 {
            color: white;
        }

        .bubble h1 { font-size: 20px; }
        .bubble h2 { font-size: 18px; }
        .bubble h3 { font-size: 16px; }

        .bubble p {
            margin: 8px 0;
        }

        .bubble ul, .bubble ol {
            margin: 8px 0 8px 24px;
        }

        .bubble li {
            margin: 4px 0;
        }

        .bubble code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 13px;
            color: #2563eb;
        }

        .message.user .bubble code {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .bubble pre {
            background: #f8fafc;
            border-radius: 10px;
            padding: 14px;
            margin: 12px 0;
            overflow-x: auto;
            border: 1px solid #e2e8f0;
        }

        .bubble pre code {
            background: none;
            padding: 0;
            color: #334155;
        }

        .bubble table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
            font-size: 13px;
        }

        .bubble th {
            background: #f8fafc;
            font-weight: 600;
        }

        .bubble th, .bubble td {
            border: 1px solid #e2e8f0;
            padding: 8px 12px;
            text-align: left;
        }

        .bubble blockquote {
            border-left: 3px solid #2563eb;
            margin: 12px 0;
            padding: 8px 16px;
            background: #f8fafc;
            color: #475569;
            font-style: italic;
        }

        .message.user .bubble blockquote {
            border-left-color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .bubble .katex {
            font-size: 1.1em;
        }

        .bubble .katex-display {
            margin: 12px 0;
            overflow-x: auto;
            overflow-y: hidden;
        }

        /* Streaming cursor */
        .streaming-cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: #2563eb;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        .message.user .streaming-cursor {
            background: white;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .timestamp {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 4px;
            margin-left: 48px;
        }

        .message.user .timestamp {
            margin-left: 0;
            margin-right: 48px;
            text-align: right;
        }

        /* Input area */
        .input-area {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid #e9eef2;
        }

        .input-container {
            display: flex;
            gap: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 4px 4px 4px 16px;
            transition: border-color 0.2s;
        }

        .input-container:focus-within {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: #1e293b;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            padding: 12px 0;
            outline: none;
        }

        textarea::placeholder {
            color: #94a3b8;
        }

        .send-btn {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            width: 42px;
            height: 42px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 4px;
            font-size: 15px;
        }

        .send-btn:hover {
            background: #1d4ed8;
            transform: scale(1.02);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Status bar */
        .status-bar {
            padding: 8px 24px;
            background: #f8fafc;
            border-top: 1px solid #e9eef2;
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 12px;
            color: #64748b;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-item i {
            color: #2563eb;
            font-size: 12px;
        }

        .status-value {
            color: #1e293b;
            font-weight: 500;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="model">
                <div class="model-icon"><i class="fas fa-microchip"></i></div>
                <span class="model-name">Gemma 3n E4B</span>
                <span class="model-badge"><i class="far fa-star"></i> 580 pts</span>
            </div>
            <button class="config-btn" onclick="openModal()">
                <i class="fas fa-sliders-h"></i> ConfiguraciÃ³n
            </button>
        </div>

        <!-- Config Modal -->
        <div class="modal" id="configModal" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3><i class="fas fa-sliders-h"></i> ConfiguraciÃ³n del modelo</h3>
                    <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
                </div>
                <div class="modal-body">
                    <!-- Presets -->
                    <div class="preset-buttons">
                        <button class="preset-btn active" onclick="setPreset('balanced')">
                            <i class="fas fa-scale-balanced"></i> Balanced
                        </button>
                        <button class="preset-btn" onclick="setPreset('creative')">
                            <i class="fas fa-feather"></i> Creative
                        </button>
                        <button class="preset-btn" onclick="setPreset('precise')">
                            <i class="fas fa-bullseye"></i> Precise
                        </button>
                        <button class="preset-btn" onclick="setPreset('fast')">
                            <i class="fas fa-gauge-high"></i> Fast
                        </button>
                    </div>

                    <!-- Temperatura -->
                    <div class="config-group">
                        <label><i class="fas fa-thermometer-half"></i> Temperatura <span style="margin-left: auto; color: #94a3b8;">Creatividad</span></label>
                        <div class="slider-container">
                            <input type="range" id="tempRange" min="0" max="1" step="0.05" value="0.3">
                            <span class="slider-value" id="tempValue">0.30</span>
                        </div>
                    </div>

                    <!-- Top P -->
                    <div class="config-group">
                        <label><i class="fas fa-chart-pie"></i> Top P <span style="margin-left: auto; color: #94a3b8;">Diversidad</span></label>
                        <div class="slider-container">
                            <input type="range" id="topPRange" min="0.1" max="1" step="0.05" value="0.95">
                            <span class="slider-value" id="topPValue">0.95</span>
                        </div>
                    </div>

                    <!-- Top K -->
                    <div class="config-group">
                        <label><i class="fas fa-list"></i> Top K <span style="margin-left: auto; color: #94a3b8;">Vocabulario</span></label>
                        <select class="select-config" id="topKSelect">
                            <option value="20">20 (Enfocado)</option>
                            <option value="40" selected>40 (Balanceado)</option>
                            <option value="60">60 (Creativo)</option>
                            <option value="80">80 (Muy creativo)</option>
                            <option value="100">100 (MÃ¡xima variedad)</option>
                        </select>
                    </div>

                    <!-- Max Tokens -->
                    <div class="config-group">
                        <label><i class="fas fa-ruler"></i> Max Tokens <span style="margin-left: auto; color: #94a3b8;">Longitud</span></label>
                        <select class="select-config" id="tokensSelect">
                            <option value="512">512 (Corto)</option>
                            <option value="1024">1K (Medio)</option>
                            <option value="2048" selected>2K (Balanceado)</option>
                            <option value="4096">4K (Largo)</option>
                            <option value="8192">8K (Muy largo)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="messages" id="messages">
            <div class="message ai">
                <div class="avatar"><i class="fas fa-robot"></i></div>
                <div>
                    <div class="bubble">
                        ðŸ‘‹ Hola, soy Gemma 3n E4B. Â¿En quÃ© puedo ayudarte?
                    </div>
                    <div class="timestamp">12:00</div>
                </div>
            </div>
        </div>

        <!-- Input -->
        <div class="input-area">
            <div class="input-container">
                <textarea id="userInput" placeholder="Escribe tu pregunta (soporta markdown, cÃ³digo, matemÃ¡ticas...)"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-thermometer-half"></i>
                <span class="status-value" id="statusTemp">0.30</span>
            </div>
            <div class="status-item">
                <i class="fas fa-chart-pie"></i>
                <span class="status-value" id="statusP">0.95</span>
            </div>
            <div class="status-item">
                <i class="fas fa-list"></i>
                <span class="status-value" id="statusK">40</span>
            </div>
            <div class="status-item">
                <i class="fas fa-ruler"></i>
                <span class="status-value" id="statusTokens">2K</span>
            </div>
            <div class="status-item" style="margin-left: auto;">
                <i class="fas fa-bolt"></i>
                <span class="status-value" id="latencyDisplay">0.38s</span>
            </div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n de marked para formateo profesional
        marked.setOptions({
            breaks: true,
            gfm: true,
            headerIds: false,
            mangle: false,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        const API_KEY = 'AIzaSyCndVtq2iXbW4fFJeAvC0gPW4UBLHw6swo';
        const MODEL = 'models/gemma-3n-e4b-it';
        
        let isProcessing = false;
        let abortController = null;
        let conversationHistory = [];
        let currentStreamingContent = '';

        // Elementos
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const modal = document.getElementById('configModal');
        
        // Config elements
        const tempRange = document.getElementById('tempRange');
        const tempValue = document.getElementById('tempValue');
        const topPRange = document.getElementById('topPRange');
        const topPValue = document.getElementById('topPValue');
        const topKSelect = document.getElementById('topKSelect');
        const tokensSelect = document.getElementById('tokensSelect');
        
        // Status elements
        const statusTemp = document.getElementById('statusTemp');
        const statusP = document.getElementById('statusP');
        const statusK = document.getElementById('statusK');
        const statusTokens = document.getElementById('statusTokens');
        const latencyDisplay = document.getElementById('latencyDisplay');

        // Update displays
        function updateStatus() {
            statusTemp.textContent = parseFloat(tempRange.value).toFixed(2);
            statusP.textContent = parseFloat(topPRange.value).toFixed(2);
            statusK.textContent = topKSelect.value;
            
            const tokens = tokensSelect.value;
            statusTokens.textContent = tokens === '512' ? '512' : 
                                      (tokens === '1024' ? '1K' : 
                                      (tokens === '2048' ? '2K' : 
                                      (tokens === '4096' ? '4K' : '8K')));
        }

        tempRange.addEventListener('input', () => {
            tempValue.textContent = parseFloat(tempRange.value).toFixed(2);
            updateStatus();
        });

        topPRange.addEventListener('input', () => {
            topPValue.textContent = parseFloat(topPRange.value).toFixed(2);
            updateStatus();
        });

        topKSelect.addEventListener('change', updateStatus);
        tokensSelect.addEventListener('change', updateStatus);

        // Presets
        function setPreset(mode) {
            document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            switch(mode) {
                case 'balanced':
                    tempRange.value = 0.3;
                    topPRange.value = 0.95;
                    topKSelect.value = '40';
                    tokensSelect.value = '2048';
                    break;
                case 'creative':
                    tempRange.value = 0.8;
                    topPRange.value = 0.95;
                    topKSelect.value = '60';
                    tokensSelect.value = '4096';
                    break;
                case 'precise':
                    tempRange.value = 0.1;
                    topPRange.value = 0.8;
                    topKSelect.value = '20';
                    tokensSelect.value = '1024';
                    break;
                case 'fast':
                    tempRange.value = 0.2;
                    topPRange.value = 0.9;
                    topKSelect.value = '30';
                    tokensSelect.value = '2048';
                    break;
            }
            
            tempValue.textContent = parseFloat(tempRange.value).toFixed(2);
            topPValue.textContent = parseFloat(topPRange.value).toFixed(2);
            updateStatus();
        }

        // Modal
        function openModal() {
            modal.classList.add('active');
        }

        function closeModal(e) {
            if (!e || e.target === modal) {
                modal.classList.remove('active');
            }
        }

        // FunciÃ³n para formatear respuestas con markdown y matemÃ¡ticas
        function formatMessage(text) {
            // Renderizar markdown
            let html = marked.parse(text);
            
            // Crear contenedor temporal para procesar KaTeX
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Procesar expresiones KaTeX ($$...$$ para display, $...$ para inline)
            const katexDisplayRegex = /\$\$([\s\S]+?)\$\$/g;
            const katexInlineRegex = /\$([^\$]+?)\$/g;
            
            // Reemplazar display math
            temp.innerHTML = temp.innerHTML.replace(katexDisplayRegex, (match, expr) => {
                try {
                    return katex.renderToString(expr, { displayMode: true, throwOnError: false });
                } catch (e) {
                    return match;
                }
            });
            
            // Reemplazar inline math
            temp.innerHTML = temp.innerHTML.replace(katexInlineRegex, (match, expr) => {
                try {
                    return katex.renderToString(expr, { displayMode: false, throwOnError: false });
                } catch (e) {
                    return match;
                }
            });
            
            return temp.innerHTML;
        }

        function addMessage(content, isUser = false, isStreaming = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
            if (isStreaming) messageDiv.id = 'streaming-message';
            
            const now = new Date();
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const formattedContent = isStreaming ? content : formatMessage(content);
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div>
                        <div class="bubble">${formattedContent}</div>
                        <div class="timestamp">${timeStr}</div>
                    </div>
                    <div class="avatar"><i class="fas fa-user"></i></div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="avatar"><i class="fas fa-robot"></i></div>
                    <div>
                        <div class="bubble" id="streaming-bubble">
                            ${formattedContent}
                            ${isStreaming ? '<span class="streaming-cursor"></span>' : ''}
                        </div>
                        <div class="timestamp">${timeStr}</div>
                    </div>
                `;
            }
            
            if (isStreaming) {
                const existing = document.getElementById('streaming-message');
                if (existing) existing.remove();
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Aplicar highlight a bloques de cÃ³digo
            messageDiv.querySelectorAll('pre code').forEach(block => {
                hljs.highlightElement(block);
            });
            
            if (!isUser && !isStreaming) {
                conversationHistory.push({ role: 'model', content: content });
            }
        }

        function updateStreamingContent(content) {
            const bubble = document.getElementById('streaming-bubble');
            if (bubble) {
                // Para streaming solo mostramos texto plano sin formato completo
                bubble.innerHTML = content.replace(/\n/g, '<br>') + '<span class="streaming-cursor"></span>';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message || isProcessing) return;
            
            if (abortController) {
                abortController.abort();
            }
            
            addMessage(message, true);
            userInput.value = '';
            userInput.style.height = 'auto';
            
            currentStreamingContent = '';
            addMessage('', false, true);
            
            isProcessing = true;
            sendBtn.disabled = true;
            userInput.disabled = true;
            
            abortController = new AbortController();
            
            try {
                const startTime = performance.now();
                
                const contents = [];
                const recentHistory = conversationHistory.slice(-10);
                recentHistory.forEach(msg => {
                    contents.push({
                        role: msg.role,
                        parts: [{ text: msg.content }]
                    });
                });
                
                contents.push({
                    role: 'user',
                    parts: [{ text: message }]
                });

                const payload = {
                    contents: contents,
                    generationConfig: {
                        temperature: parseFloat(tempRange.value),
                        maxOutputTokens: parseInt(tokensSelect.value),
                        topP: parseFloat(topPRange.value),
                        topK: parseInt(topKSelect.value),
                    }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${MODEL}:streamGenerateContent?key=${API_KEY}&alt=sse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(5));
                                if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                                    const text = data.candidates[0].content.parts[0].text;
                                    fullResponse += text;
                                    updateStreamingContent(fullResponse);
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }

                const responseTime = ((performance.now() - startTime) / 1000).toFixed(2);
                latencyDisplay.textContent = responseTime + 's';
                
                const streamingMsg = document.getElementById('streaming-message');
                if (streamingMsg) {
                    streamingMsg.remove();
                }
                addMessage(fullResponse);
                
                conversationHistory.push({ role: 'user', content: message });
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    const streamingMsg = document.getElementById('streaming-message');
                    if (streamingMsg) streamingMsg.remove();
                    addMessage(`âŒ Error: ${error.message}`);
                }
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
                userInput.disabled = false;
                userInput.focus();
                abortController = null;
            }
        }

        // Auto-resize
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Enter to send
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize
        updateStatus();
        tempRange.dispatchEvent(new Event('input'));
        topPRange.dispatchEvent(new Event('input'));
    </script>
</body>
</html>