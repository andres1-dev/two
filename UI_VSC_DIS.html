<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Distribución PandaDash - VSCode Style</title>
  
  <!-- Codicons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codicons@0.0.32/font/codicons.min.css">
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  
  <style>
    :root {
      /* Colores modo VSCode */
      --vscode-background: #ffffff;
      --vscode-sidebar-background: #f3f3f3;
      --vscode-panel-background: #f8f8f8;
      --vscode-input-background: #ffffff;
      --vscode-input-border: #cecece;
      --vscode-foreground: #616161;
      --vscode-list-activeSelectionBackground: #e4e6f1;
      --vscode-list-hoverBackground: #f0f0f0;
      --vscode-button-background: #007acc;
      --vscode-button-foreground: #ffffff;
      --vscode-button-hoverBackground: #005a9e;
      --vscode-border: #e1e4e8;
      --vscode-focusBorder: #007acc;
      --vscode-badge-background: #c4c4c4;
      --vscode-badge-foreground: #333333;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      color: var(--vscode-foreground);
      background-color: var(--vscode-background);
    }

    .vscode-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* Panel lateral simplificado */
    .sidebar {
      width: 280px;
      background-color: var(--vscode-sidebar-background);
      border-right: 1px solid var(--vscode-border);
      padding: 15px;
      overflow-y: auto;
    }

    .sidebar-section {
      margin-bottom: 25px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 10px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Área principal */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Barra de herramientas */
    .toolbar {
      padding: 10px 15px;
      background-color: var(--vscode-panel-background);
      border-bottom: 1px solid var(--vscode-border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Contenido principal */
    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* Componentes VSCode */
    .vscode-input {
      padding: 8px 10px;
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      color: var(--vscode-foreground);
      border-radius: 3px;
      font-size: 14px;
      width: 100%;
    }

    .vscode-input:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
    }

    .vscode-button {
      padding: 8px 12px;
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.2s;
    }

    .vscode-button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .vscode-button.secondary {
      background-color: transparent;
      color: var(--vscode-foreground);
      border: 1px solid var(--vscode-border);
    }

    .vscode-button.secondary:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .vscode-checkbox {
      width: 16px;
      height: 16px;
      accent-color: var(--vscode-button-background);
    }

    /* Estilos específicos de la aplicación */
    .distribution-section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--vscode-foreground);
    }

    .distribution-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 15px;
    }

    .distribution-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: var(--vscode-input-background);
      border: 1px solid var(--vscode-border);
      border-radius: 4px;
    }

    .distribution-label {
      min-width: 80px;
      font-size: 13px;
      font-weight: 500;
    }

    .number-input {
      width: 70px;
      padding: 6px 8px;
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      color: var(--vscode-foreground);
      border-radius: 3px;
      font-size: 13px;
      text-align: center;
    }

    .number-input:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
    }

    .principal-input {
      background-color: #e3f2fd;
      font-weight: 600;
      border-color: #bbdefb;
    }

    /* Tabla de resultados */
    .table-container {
      width: 100%;
      overflow: auto;
      border: 1px solid var(--vscode-border);
      border-radius: 4px;
      margin-top: 15px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--vscode-border);
    }

    th {
      background-color: var(--vscode-panel-background);
      font-weight: 600;
      position: sticky;
      top: 0;
      color: var(--vscode-button-background);
    }

    tr:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .total-row {
      background-color: var(--vscode-list-activeSelectionBackground);
      font-weight: 600;
    }

    .valor-negativo {
      color: #e74c3c;
      font-weight: 600;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      flex-direction: column;
      gap: 15px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--vscode-border);
      border-top: 3px solid var(--vscode-button-background);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--vscode-background);
      border: 1px solid var(--vscode-border);
      border-radius: 4px;
      width: 500px;
      max-width: 90%;
      max-height: 80%;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid var(--vscode-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--vscode-panel-background);
    }

    .modal-body {
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid var(--vscode-border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .filter-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      border-radius: 3px;
      transition: background-color 0.2s;
    }

    .filter-option:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    /* Controles de tabla */
    .mayorista-column-header {
      text-align: center;
    }

    .header-controls {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
      margin-top: 5px;
    }

    .btn-group {
      display: flex;
      gap: 3px;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }

    .global-mayorista-input {
      width: 60px;
      padding: 4px;
      text-align: center;
    }

    .mayorista-input {
      width: 60px;
      padding: 4px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="vscode-container">
    <!-- Panel lateral -->
    <div class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="codicon codicon-search"></span>
          Búsqueda REC
        </div>
        <input type="number" class="vscode-input" id="recInput" placeholder="Número de REC" oninput="searchRec()">
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="codicon codicon-rocket"></span>
          Acciones Rápidas
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button class="vscode-button" onclick="searchRec()">
            <span class="codicon codicon-search"></span>
            Buscar REC
          </button>
          <button class="vscode-button secondary" onclick="reloadAllData()">
            <span class="codicon codicon-refresh"></span>
            Actualizar Datos
          </button>
          <button class="vscode-button" onclick="saveAllDistributionsFast()">
            <span class="codicon codicon-save"></span>
            Guardar Distribución
          </button>
          <button class="vscode-button secondary" onclick="window.print()">
            <span class="codicon codicon-print"></span>
            Imprimir
          </button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="codicon codicon-organization"></span>
          Distribución Empresas
        </div>
        <div id="empresasContainer"></div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="codicon codicon-account"></span>
          Mayoristas Activos
        </div>
        <div id="mayoristasContainer"></div>
      </div>
    </div>

    <!-- Área principal -->
    <div class="main-content">
      <div class="toolbar">
        <span style="font-weight: 600; font-size: 16px;">Distribución PandaDash</span>
        <div style="flex: 1;"></div>
        <button class="vscode-button secondary" onclick="confirmarCambio()">
          <span class="codicon codicon-repo-push"></span>
          Cambiar Sistema
        </button>
      </div>

      <div class="content">
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <div>Cargando datos del sistema...</div>
        </div>
        
        <div id="searchContainer" style="display:none">
          <!-- Resultados de búsqueda -->
          <div id="result"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para filtros -->
  <div id="filterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin: 0; font-size: 16px;">Filtrar Mayoristas</h3>
        <span class="codicon codicon-close" style="cursor: pointer; font-size: 18px;" onclick="closeModal('filterModal')"></span>
      </div>
      <div class="modal-body">
        <div class="distribution-section" style="margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px;">Excluir Colores</h4>
          <div id="colorFilters" class="filter-options"></div>
        </div>
        <div class="distribution-section">
          <h4 style="margin-bottom: 10px;">Excluir Tallas</h4>
          <div id="tallaFilters" class="filter-options"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="vscode-button secondary" onclick="closeModal('filterModal')">Cancelar</button>
        <button class="vscode-button" id="applyFilters">Aplicar Filtros</button>
      </div>
    </div>
  </div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // VARIABLES GLOBALES EXACTAMENTE IGUALES AL CÓDIGO ORIGINAL
    const API_KEY = "AIzaSyC7hjbRc0TGLgImv8gVZg8tsOeYWgXlPcM";
    const SOURCE_SPREADSHEET_ID = "1esc5REq0c03nHLpGcLwZRW29yq2gZnrpbz75gCCjrqc";
    const SECONDARY_SPREADSHEET_ID = "133NiyjNApZGkEFs4jUvpJ9So-cSEzRVeW2FblwOCrjI";

    let allRecData = [];
    let allConfigData = {};
    let activeMayoristas = [];
    let empresasData = [];
    let currentRecData = null;
    let colorOptions = [];
    let tallaOptions = [];
    let mayoristaFilters = {};
    let currentFilterMayorista = null;

    // CONFIGURACIÓN FIJA DE CLIENTES EXACTAMENTE IGUAL
    const CLIENTES_CONFIG = {
      "67006141": {"id":"67006141","razonSocial":"QUINTERO ORTIZ PATRICIA YAMILET","nombreCorto":"Yamilet","tipoCliente":"Mayorista","estado":"Activo","direccion":"CL 26 # 7 - 21","telefono":"3122441788","email":"p.yamiletquino@hotmail.com"},
      "805027653": {"id":"805027653","razonSocial":"EL TEMPLO DE LA MODA S.A.S.","nombreCorto":"Templo","tipoCliente":"Empresa","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3143927031","email":"auxiliarcdi@eltemplodelamoda.com.co","tipoEmpresa":"Principal"},
      "900021825": {"id":"900021825","razonSocial":"INDUALPES S.A.S","nombreCorto":"Indualpes","tipoCliente":"Mayorista","estado":"Activo","direccion":"CR 52 29 A 111 BG 205","telefono":"","email":"gerencia@indualpes.com"},
      "900047252": {"id":"900047252","razonSocial":"EL TEMPLO DE LA MODA FRESCA S.A.S.","nombreCorto":"Shopping","tipoCliente":"Empresa","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3185859934","email":"bodega@eltemplodelamodafresca.com","tipoEmpresa":"Secundaria"},
      "900616124": {"id":"900616124","razonSocial":"TEXTILES Y CREACIONES EL UNIVERSO S.A.S.","nombreCorto":"Universo","tipoCliente":"Mayorista","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3168007979","email":"coordinadorlogistico@eltemplodelamoda.com.co"},
      "900692469": {"id":"900692469","razonSocial":"TEXTILES Y CREACIONES LOS ANGELES S.A.S.","nombreCorto":"Ángeles","tipoCliente":"Proveedor","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3154799895","email":"gerencia@tclosangeles.com"},
      "901920844": {"id":"901920844","razonSocial":"INVERSIONES URBANA SAS","nombreCorto":"Ruben","tipoCliente":"Mayorista","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3103944800","email":"contabilidad@eltemplodelamoda.com.co"},
      "1007348825": {"id":"1007348825","razonSocial":"ZULUAGA GOMEZ RUBEN ESTEBAN","nombreCorto":"Esteban","tipoCliente":"Mayorista","estado":"Activo","direccion":"CONDOMINIO CAMPESTRE LAS MERCEDES","telefono":"3205702698","email":"contabilidad@eltemplodelamoda.com.co"},
      "900616124-1": {"id":"900616124","razonSocial":"TEXTILES Y CREACIONES EL UNIVERSO S.A.S.","nombreCorto":"Universo","tipoCliente":"Proveedor","estado":"Activo","direccion":"CALLE 26 # 7 - 21","telefono":"3168007979","email":"coordinadorlogistico@eltemplodelamoda.com.co"},
      "70825517-1": {"id":"70825517","razonSocial":"ARISTIZABAL LOPEZ JESUS MARIA","nombreCorto":"Jesús","tipoCliente":"Mayorista","estado":"Activo","direccion":"CL 26 # 7 - 21","telefono":"3122441788","email":"p.yamiletquino@hotmail.com"},
      "70825517-2": {"id":"14838951","razonSocial":"QUINTERO ORTIZ JOSE ALEXANDER","nombreCorto":"Alex","tipoCliente":"Mayorista","estado":"Activo","direccion":"CL 26 # 7 - 21","telefono":"3104624213","email":"alexander511933@hotmail.com"}
    };

    // FUNCIONES PRINCIPALES - MANTENIENDO TODA LA LÓGICA ORIGINAL

    // Cargar datos al iniciar
    function initialize() {
      document.getElementById('loading').style.display = 'flex';
      
      Promise.all([
        cargarTodosLosDatos(),
        cargarConfiguraciones()
      ]).then(([recData, configData]) => {
        handleRecData(recData);
        handleConfigData(configData);
      }).catch(handleError);
    }

    // Función para cargar datos unificados (ORIGINAL)
    async function cargarTodosLosDatos() {
      try {
        const [json1, json2] = await Promise.all([
          getSheetDataAsJSON_1(),  // DATA2
          getSheetDataAsJSON_2()   // DataBase
        ]);

        const arr1 = JSON.parse(json1);
        const arr2 = JSON.parse(json2);
        const unified = arr1.concat(arr2);

        return unified;
      } catch (error) {
        console.error('Error cargando datos:', error);
        throw error;
      }
    }

    // REPLICA EXACTA de getSheetDataAsJSON_1() de GAS
    async function getSheetDataAsJSON_1() {
      const SPREADSHEET_ID = "133NiyjNApZGkEFs4jUvpJ9So-cSEzRVeW2FblwOCrjI";
      const SHEET_NAME = "DATA2";
      const RANGE = `${SHEET_NAME}!S2:S`;

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Error HTTP DATA2: ${response.status}`);
      }

      const data = await response.json();

      if (!data.values || data.values.length === 0) {
        return JSON.stringify({ error: "No data found" });
      }

      const jsonEntries = data.values.map(row => row[0]).filter(val => val && val.trim() !== "");
      const finalJsonString = `[${jsonEntries.join(",")}]`;

      return finalJsonString;
    }

    // REPLICA EXACTA de getSheetDataAsJSON_2() de GAS
    async function getSheetDataAsJSON_2() {
      const range = "DataBase!A:HR";
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SOURCE_SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;
      
      const response = await fetch(url);
      if (!response.ok) {
        throw new Error(`Error HTTP DataBase: ${response.status}`);
      }

      const data = await response.json();

      if (!data.values) {
        return JSON.stringify({ error: "No data found" });
      }

      const datos = data.values;
      let result = [];
      let lotesAnexos = {};
      let lotesHrPendientes = {};

      for (let i = 0; i < datos.length; i++) {
        if (datos[i][0]) {
          const valueA = datos[i][0].toString().trim();

          if (valueA.startsWith("REC")) {
            const numberPart = valueA.replace("REC", "").trim();
            
            let proveedor = "TEXTILES Y CREACIONES EL UNIVERSO S.A.S.";
            if (datos[i][3] && datos[i][3].toString().trim() === "LINEA ANGELES") {
              proveedor = "TEXTILES Y CREACIONES LOS ANGELES S.A.S.";
            }

            let loteActual = datos[i][8] || "";
            let tipoActual = datos[i][27] || "";

            if (!lotesAnexos[loteActual]) {
              lotesAnexos[loteActual] = [];
              lotesHrPendientes[loteActual] = [];
            }

            if (tipoActual !== "FULL") {
              lotesAnexos[loteActual].push({
                "DOCUMENTO": numberPart,
                "TIPO": tipoActual,
                "CANTIDAD": datos[i][18] || ""
              });

              if (tipoActual === "PENDIENTES" && datos[i][225]) {
                const hrPendiente = datos[i][225].toString().split("☬").map(row => row.split("∞"));
                lotesHrPendientes[loteActual] = lotesHrPendientes[loteActual].concat(hrPendiente);
              }
            }

            if (tipoActual === "FULL") {
              let extensiones = [];
              if (datos[i][225]) {
                extensiones = datos[i][225].toString().split("☬").map(row => row.split("∞"));
              }

              result.push({
                "A": numberPart,
                "FECHA": datos[i][1] || "",
                "TALLER": datos[i][2] || "",
                "LINEA": datos[i][3] || "",
                "AUDITOR": datos[i][4] || "",
                "ESCANER": datos[i][5] || "",
                "LOTE": loteActual,
                "REFERENCIA": datos[i][6] || "",
                "DESCRIPCIÓN": datos[i][9] || "",
                "CANTIDAD": datos[i][18] || "",
                "TEMPLO": datos[i][26] || "",
                "TIPO": tipoActual,
                "PVP": datos[i][28] || "",
                "PRENDA": datos[i][29] || "",
                "GENERO": datos[i][30] || "",
                "HR": extensiones,
                "PROVEEDOR": proveedor,
                "ANEXO": []
              });
            }
          }
        }
      }

      // Combinar HRs y anexos
      result.forEach(item => {
        if (lotesAnexos[item.LOTE]) {
          item.ANEXO = lotesAnexos[item.LOTE];
        }

        if (lotesHrPendientes[item.LOTE] && lotesHrPendientes[item.LOTE].length > 0) {
          const hrPrincipal = item.HR;
          const hrPendientes = lotesHrPendientes[item.LOTE];
          
          const combinedHrMap = {};
          
          hrPrincipal.forEach(itemHr => {
            const codigo = itemHr[0];
            if (codigo) combinedHrMap[codigo] = [...itemHr];
          });
          
          hrPendientes.forEach(itemHr => {
            const codigo = itemHr[0];
            if (codigo) {
              if (combinedHrMap[codigo]) {
                const cantidadExistente = parseInt(combinedHrMap[codigo][3]) || 0;
                const cantidadNueva = parseInt(itemHr[3]) || 0;
                combinedHrMap[codigo][3] = (cantidadExistente + cantidadNueva).toString();
              } else {
                combinedHrMap[codigo] = [...itemHr];
              }
            }
          });
          
          item.HR = Object.values(combinedHrMap);
        }
      });

      return JSON.stringify(result, null, 2);
    }

    // Cargar configuraciones desde objeto fijo
    function cargarConfiguraciones() {
      return new Promise((resolve) => {
        // Convertir el objeto CLIENTES_CONFIG al formato esperado
        const configArray = Object.entries(CLIENTES_CONFIG).map(([id, config]) => ({
          id: id,
          ...config
        }));
        resolve(configArray);
      });
    }

    function handleRecData(recData) {
      allRecData = recData;
      if (allConfigData) refreshUI();
    }
    
    function handleConfigData(configData) {
      allConfigData = configData.reduce((acc, config) => {
        acc[config.id] = config;
        return acc;
      }, {});
      processConfigData();
      if (allRecData) refreshUI();
    }
    
    function processConfigData() {
      // Procesar empresas
      empresasData = Object.entries(allConfigData)
        .filter(([id, config]) => config.tipoEmpresa)
        .sort((a, b) => {
          if (a[1].tipoEmpresa !== b[1].tipoEmpresa) {
            return a[1].tipoEmpresa === "Principal" ? -1 : 1;
          }
          return a[1].nombreCorto.localeCompare(b[1].nombreCorto);
        });
      
      // Inicializar filtros para mayoristas
      Object.entries(allConfigData)
        .filter(([id, config]) => config.tipoCliente === "Mayorista")
        .forEach(([id, config]) => {
          mayoristaFilters[id] = {
            excludedColors: [],
            excludedTallas: []
          };
        });
    }
    
    function refreshUI() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('searchContainer').style.display = 'block';
      generateEmpresasUI();
      generateMayoristasUI();
      const recNumber = document.getElementById('recInput').value.trim();
      if (recNumber) searchRec();
    }

    function generateEmpresasUI() {
      const container = document.getElementById('empresasContainer');
      container.innerHTML = '';

      if (empresasData.length === 0) {
        container.innerHTML = '<p style="font-size: 13px; color: #666;">No hay empresas configuradas</p>';
        return;
      }

      empresasData.forEach(([id, config]) => {
        const item = document.createElement('div');
        item.className = 'distribution-item';
        
        const label = document.createElement('div');
        label.className = 'distribution-label';
        label.textContent = config.nombreCorto + ':';
        
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'number-input';
        input.min = '0';
        input.max = '100';
        input.value = config.tipoEmpresa === "Principal" ? '100' : '0';
        input.dataset.tipo = config.tipoEmpresa;
        input.dataset.id = id;

        if (config.tipoEmpresa === "Principal") {
          input.readOnly = true;
          input.classList.add('principal-input');
        } else {
          input.addEventListener('input', updateEmpresaPercentage);
        }
        
        item.appendChild(label);
        item.appendChild(input);
        container.appendChild(item);
      });
    }
    
    function generateMayoristasUI() {
      const container = document.getElementById('mayoristasContainer');
      const mayoristas = Object.entries(allConfigData)
        .filter(([id, config]) => config.tipoCliente === "Mayorista")
        .sort((a, b) => a[1].nombreCorto.localeCompare(b[1].nombreCorto));
      
      if (mayoristas.length === 0) {
        container.innerHTML = '<p style="font-size: 13px; color: #666;">No hay mayoristas configurados</p>';
        return;
      }
      
      mayoristas.forEach(([id, config]) => {
        const item = document.createElement('div');
        item.className = 'distribution-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'vscode-checkbox';
        checkbox.id = `mayorista-${id}`;
        checkbox.value = id;
        checkbox.dataset.nombre = config.nombreCorto;
        checkbox.addEventListener('change', updateHrColumns);
        
        const label = document.createElement('label');
        label.htmlFor = `mayorista-${id}`;
        label.textContent = config.nombreCorto;
        label.style.cursor = 'pointer';
        label.style.fontSize = '13px';
        
        item.appendChild(checkbox);
        item.appendChild(label);
        container.appendChild(item);
      });
    }

    // LAS DEMÁS FUNCIONES SE MANTIENEN EXACTAMENTE IGUALES AL CÓDIGO ORIGINAL
    // Solo cambio la presentación visual pero la funcionalidad es IDÉNTICA

    function updateEmpresaPercentage(event) {
      const input = event.target;
      let value = parseInt(input.value) || 0;
      value = Math.max(0, Math.min(100, value));
      input.value = value;
      updatePrincipalValue();
      updateAllValues();
    }
    
    function updatePrincipalValue() {
      const principal = empresasData.find(([id, config]) => config.tipoEmpresa === "Principal");
      if (!principal) return;
      
      const principalInput = document.querySelector(`input[data-id="${principal[0]}"]`);
      if (!principalInput) return;
      
      let totalSecundarias = 0;
      empresasData.forEach(([id, config]) => {
        if (config.tipoEmpresa === "Secundaria") {
          const input = document.querySelector(`input[data-id="${id}"]`);
          if (input) totalSecundarias += parseInt(input.value) || 0;
        }
      });
      
      principalInput.value = 100 - totalSecundarias;
    }

    function searchRec() {
      const recNumber = document.getElementById('recInput').value.trim();
      const resultDiv = document.getElementById('result');
      
      if (!recNumber) {
        resultDiv.innerHTML = '';
        return;
      }
      
      currentRecData = allRecData.find(item => item.A === recNumber);
      displayResults(currentRecData);
    }
    
    function displayResults(recData) {
      const resultDiv = document.getElementById('result');
      
      if (!recData) {
        resultDiv.innerHTML = '<p style="color: #e74c3c; font-size: 14px;">No se encontró el REC</p>';
        return;
      }
      
      resultDiv.innerHTML = generateResultsHTML(recData);
      attachInputEvents();
      updateAllValues();
    }

    function generateResultsHTML(recData) {
      let html = '<div class="section-title"><span class="codicon codicon-file"></span>Resultados del REC ' + recData.A + '</div>';
      
      if (!recData.HR || recData.HR.length === 0) {
        return html + '<p style="color: #666;">No hay extensiones para este REC</p>';
      }
      
      html += '<div class="table-container"><table><thead><tr>';
      
      // Columnas fijas
      html += '<th>Código</th>';
      html += '<th>Color</th>';
      html += '<th>Talla</th>';
      html += '<th>Cantidad</th>';
      
      // Columnas de empresas
      empresasData.forEach(([id, config]) => {
        html += `<th>${config.nombreCorto}</th>`;
      });
      
      // Columnas de mayoristas
      activeMayoristas.forEach(mayorista => {
        html += `
          <th>
            <div class="mayorista-column-header">
              <div style="font-weight: 600; margin-bottom: 5px;">${mayorista.nombre}</div>
              <div class="header-controls">
                <div class="btn-group">
                  <button class="vscode-button btn-sm" style="padding: 4px 6px;" onclick="distributeGlobalQuantity(event)" data-mayorista="${mayorista.id}" title="Distribuir">
                    <span class="codicon codicon-share"></span>
                  </button>
                  <button class="vscode-button secondary btn-sm" style="padding: 4px 6px;" onclick="openFilterModal(event)" data-mayorista="${mayorista.id}" title="Filtrar">
                    <span class="codicon codicon-filter"></span>
                  </button>
                  <button class="vscode-button secondary btn-sm" style="padding: 4px 6px; background-color: #e74c3c; color: white;" onclick="clearMayoristaValues(event)" data-mayorista="${mayorista.id}" title="Limpiar">
                    <span class="codicon codicon-clear-all"></span>
                  </button>
                </div>
                <input type="number" min="0" class="number-input global-mayorista-input" 
                       data-mayorista="${mayorista.id}" value="0" placeholder="Cant." style="margin-top: 3px;">
              </div>
            </div>
          </th>
        `;
      });
      
      html += '</tr></thead><tbody>';
      
      // Filas de datos
      recData.HR.forEach((row, rowIndex) => {
        const codigo = formatCellValue(row[0]);
        const color = formatCellValue(row[1]);
        const talla = formatCellValue(row[2]);
        const cantidad = parseFloat(row[3]) || 0;
        
        html += `<tr>`;
        html += `<td>${codigo}</td>`;
        html += `<td>${color}</td>`;
        html += `<td>${talla}</td>`;
        html += `<td>${cantidad}</td>`;
        
        // Valores para empresas
        empresasData.forEach(([id, config]) => {
          if (config.tipoEmpresa === "Principal") {
            html += `<td class="principal-cell" data-row="${rowIndex}">${cantidad}</td>`;
          } else {
            html += `<td class="secundaria-cell" data-row="${rowIndex}" data-empresa="${id}">0</td>`;
          }
        });
        
        // Inputs para mayoristas
        activeMayoristas.forEach(mayorista => {
          html += `
            <td>
              <input type="number" min="0" max="${cantidad}" 
                     class="number-input mayorista-input" 
                     data-row="${rowIndex}" 
                     data-mayorista="${mayorista.id}"
                     value="0"
                     data-color="${color}"
                     data-talla="${talla}">
            </td>
          `;
        });
        
        html += '</tr>';
      });
      
      // Fila de totales
      html += '<tr class="total-row">';
      html += '<td colspan="3"><strong>Total</strong></td>';
      
      const totalCantidad = recData.HR.reduce((sum, row) => sum + (parseFloat(row[3]) || 0), 0);
      html += `<td><strong>${totalCantidad}</strong></td>`;
      
      // Totales empresas
      empresasData.forEach(([id, config]) => {
        if (config.tipoEmpresa === "Principal") {
          html += `<td><strong class="principal-total">${totalCantidad}</strong></td>`;
        } else {
          html += `<td><strong class="secundaria-total" data-empresa="${id}">0</strong></td>`;
        }
      });
      
      // Totales mayoristas
      activeMayoristas.forEach(mayorista => {
        html += `<td><strong class="mayorista-total" data-mayorista="${mayorista.id}">0</strong></td>`;
      });
      
      html += '</tr></tbody></table></div>';
      
      return html;
    }

    // MANTENGO TODAS LAS FUNCIONES RESTANTES EXACTAMENTE IGUALES
    function attachInputEvents() {
      document.querySelectorAll('.mayorista-input').forEach(input => {
        input.addEventListener('input', updateMayoristaInput);
      });
      
      document.querySelectorAll('.global-mayorista-input').forEach(input => {
        input.addEventListener('input', updateGlobalMayoristaValue);
      });
    }

    function updateMayoristaInput(event) {
      const input = event.target;
      const rowIndex = input.dataset.row;
      const mayoristaId = input.dataset.mayorista;
      const value = parseInt(input.value) || 0;
      const total = parseInt(document.querySelector(`tbody tr:nth-child(${parseInt(rowIndex) + 1}) td:nth-child(4)`).textContent) || 0;
      
      let assignedToOthers = 0;
      activeMayoristas.forEach(m => {
        if (m.id !== mayoristaId) {
          const otherInput = document.querySelector(`.mayorista-input[data-row="${rowIndex}"][data-mayorista="${m.id}"]`);
          assignedToOthers += parseInt(otherInput?.value) || 0;
        }
      });
      
      if (value + assignedToOthers > total) {
        input.value = Math.max(0, total - assignedToOthers);
      }
      
      updateAllValues();
    }

    function updateGlobalMayoristaValue(event) {
      const input = event.target;
      const mayoristaId = input.dataset.mayorista;
      const value = parseInt(input.value) || 0;
      
      const totalDisponible = currentRecData.HR.reduce((sum, row) => sum + (parseFloat(row[3]) || 0), 0);
      
      let assignedToOthers = 0;
      activeMayoristas.forEach(m => {
        if (m.id !== mayoristaId) {
          const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${m.id}"]`);
          assignedToOthers += parseInt(globalInput?.value) || 0;
        }
      });
      
      if (value + assignedToOthers > totalDisponible) {
        input.value = Math.max(0, totalDisponible - assignedToOthers);
      }
    }

    function updateAllValues() {
      if (!currentRecData || !currentRecData.HR) return;
      
      currentRecData.HR.forEach((row, rowIndex) => {
        const tr = document.querySelector(`tbody tr:nth-child(${rowIndex + 1})`);
        if (!tr) return;
        
        const total = parseInt(tr.cells[3].textContent) || 0;
        
        let assignedToMayoristas = 0;
        activeMayoristas.forEach(mayorista => {
          const input = tr.querySelector(`.mayorista-input[data-mayorista="${mayorista.id}"]`);
          assignedToMayoristas += parseInt(input?.value) || 0;
        });
        
        if (assignedToMayoristas > total) {
          const ratio = total / assignedToMayoristas;
          activeMayoristas.forEach(mayorista => {
            const input = tr.querySelector(`.mayorista-input[data-mayorista="${mayorista.id}"]`);
            if (input && input.value > 0) {
              input.value = Math.max(1, Math.floor(parseInt(input.value) * ratio));
            }
          });
          assignedToMayoristas = total;
        }
        
        const availableForCompanies = total - assignedToMayoristas;
        
        empresasData.forEach(([id, config]) => {
          if (config.tipoEmpresa === "Secundaria") {
            const input = document.querySelector(`input[data-id="${id}"]`);
            const porcentaje = input ? parseInt(input.value) || 0 : 0;
            const valorSecundaria = Math.round(availableForCompanies * porcentaje / 100);
            
            const secundariaCell = tr.querySelector(`.secundaria-cell[data-empresa="${id}"]`);
            if (secundariaCell) secundariaCell.textContent = valorSecundaria;
          }
        });
        
        let asignadoSecundarias = 0;
        empresasData.forEach(([id, config]) => {
          if (config.tipoEmpresa === "Secundaria") {
            const secundariaCell = tr.querySelector(`.secundaria-cell[data-empresa="${id}"]`);
            asignadoSecundarias += parseInt(secundariaCell?.textContent) || 0;
          }
        });
        
        const principalValue = Math.max(0, availableForCompanies - asignadoSecundarias);
        const principalCell = tr.querySelector('.principal-cell');
        if (principalCell) principalCell.textContent = principalValue;
      });
      
      updateTotals();
    }

    function updateTotals() {
      if (!currentRecData) return;
      
      // Totales para mayoristas
      activeMayoristas.forEach(mayorista => {
        let total = 0;
        document.querySelectorAll(`.mayorista-input[data-mayorista="${mayorista.id}"]`).forEach(input => {
          total += parseInt(input.value) || 0;
        });
        const totalElement = document.querySelector(`.mayorista-total[data-mayorista="${mayorista.id}"]`);
        if (totalElement) totalElement.textContent = total;
      });
      
      // Totales para empresas
      empresasData.forEach(([id, config]) => {
        if (config.tipoEmpresa === "Principal") {
          let totalPrincipal = 0;
          document.querySelectorAll('.principal-cell').forEach(cell => {
            totalPrincipal += parseInt(cell.textContent) || 0;
          });
          const principalTotalElement = document.querySelector('.principal-total');
          if (principalTotalElement) {
            principalTotalElement.textContent = totalPrincipal;
            principalTotalElement.classList.toggle('valor-negativo', totalPrincipal < 0);
          }
        } else {
          let totalSecundaria = 0;
          document.querySelectorAll(`.secundaria-cell[data-empresa="${id}"]`).forEach(cell => {
            totalSecundaria += parseInt(cell.textContent) || 0;
          });
          const totalElement = document.querySelector(`.secundaria-total[data-empresa="${id}"]`);
          if (totalElement) totalElement.textContent = totalSecundaria;
        }
      });
    }

    function updateHrColumns() {
      const changedCheckbox = event.target;
      const mayoristaId = changedCheckbox.value;
      const isNowChecked = changedCheckbox.checked;
      
      const savedMayoristaValues = {};
      activeMayoristas.forEach(mayorista => {
        if (mayorista.id !== mayoristaId) {
          savedMayoristaValues[mayorista.id] = [];
          document.querySelectorAll(`.mayorista-input[data-mayorista="${mayorista.id}"]`).forEach((input, index) => {
            savedMayoristaValues[mayorista.id][index] = input.value;
          });
        }
      });
      
      const savedEmpresaValues = {};
      empresasData.forEach(([id, config]) => {
        const input = document.querySelector(`input[data-id="${id}"]`);
        if (input) savedEmpresaValues[id] = input.value;
      });
      
      if (!isNowChecked) {
        const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
        if (globalInput) globalInput.value = '0';
        
        document.querySelectorAll(`.mayorista-input[data-mayorista="${mayoristaId}"]`).forEach(input => {
          input.value = '0';
        });
      }
      
      activeMayoristas = [];
      document.querySelectorAll('#mayoristasContainer input[type="checkbox"]:checked').forEach(checkbox => {
        activeMayoristas.push({
          id: checkbox.value,
          nombre: checkbox.dataset.nombre
        });
      });
      
      refreshDisplayPreservingValues({
        empresas: savedEmpresaValues,
        mayoristas: savedMayoristaValues
      });
      
      updateTotals();
    }

    function refreshDisplayPreservingValues(savedValues = {}) {
      const recNumber = document.getElementById('recInput').value.trim();
      if (!recNumber) return;
      
      if (currentRecData) {
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = generateResultsHTML(currentRecData);
        attachInputEvents();
        
        if (savedValues.empresas) {
          Object.keys(savedValues.empresas).forEach(id => {
            const input = document.querySelector(`input[data-id="${id}"]`);
            if (input) {
              input.value = savedValues.empresas[id];
              if (input.dataset.tipo === "Secundaria") {
                const event = new Event('input');
                input.dispatchEvent(event);
              }
            }
          });
        }
        
        if (savedValues.mayoristas) {
          Object.keys(savedValues.mayoristas).forEach(mayoristaId => {
            const values = savedValues.mayoristas[mayoristaId];
            values.forEach((value, rowIndex) => {
              const input = document.querySelector(`.mayorista-input[data-row="${rowIndex}"][data-mayorista="${mayoristaId}"]`);
              if (input) {
                input.value = value;
              }
            });
          });
        }
        
        updateAllValues();
      }
    }

    function formatCellValue(value) {
      if (value == null) return '';
      if (Array.isArray(value)) return value.join(', ');
      if (typeof value === 'object') return JSON.stringify(value);
      return String(value);
    }
    
    function handleError(error) {
      console.error("Error:", error);
      document.getElementById('loading').innerHTML = `
        <div style="text-align: center; color: #e74c3c;">
          <span class="codicon codicon-error" style="font-size: 32px; margin-bottom: 10px;"></span>
          <div>Error cargando datos: ${error.message}</div>
          <button class="vscode-button" onclick="initialize()" style="margin-top: 15px;">Reintentar</button>
        </div>
      `;
    }
    
    function reloadAllData() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('loading').innerHTML = `
        <div class="spinner"></div>
        <div>Actualizando datos...</div>
      `;
      document.getElementById('result').innerHTML = '';
      initialize();
    }

    function distributeGlobalQuantity(event) {
      const btn = event.target.closest('.vscode-button');
      const mayoristaId = btn.dataset.mayorista;
      const input = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
      let totalToDistribute = parseInt(input.value) || 0;
      
      if (totalToDistribute <= 0) return;
      
      const filters = mayoristaFilters[mayoristaId] || { excludedColors: [], excludedTallas: [] };
      
      const rows = Array.from(document.querySelectorAll('tbody tr:not(.total-row)'))
        .filter(row => {
          const color = row.cells[1].textContent;
          const talla = row.cells[2].textContent;
          const total = parseInt(row.cells[3].textContent) || 0;
          return total > 0 && 
                 !filters.excludedColors.includes(color) && 
                 !filters.excludedTallas.includes(talla);
        });
      
      if (rows.length === 0) {
        alert('No hay filas disponibles para distribuir');
        return;
      }
      
      document.querySelectorAll(`.mayorista-input[data-mayorista="${mayoristaId}"]`).forEach(input => {
        input.value = '0';
      });
      
      const availableRows = rows.map(row => {
        const rowIndex = Array.from(row.parentNode.children).indexOf(row);
        const total = parseInt(row.cells[3].textContent) || 0;
        
        let assignedToOthers = 0;
        activeMayoristas.forEach(m => {
          if (m.id !== mayoristaId) {
            const otherInput = row.querySelector(`.mayorista-input[data-mayorista="${m.id}"]`);
            assignedToOthers += parseInt(otherInput?.value) || 0;
          }
        });
        
        const disponible = Math.max(0, total - assignedToOthers);
        
        return {
          row: row,
          tdm: disponible,
          rowIndex: rowIndex
        };
      });
      
      const result = smartDistribution(availableRows, totalToDistribute);
      
      let totalAsignado = 0;
      result.forEach(item => {
        const input = item.row.querySelector(`.mayorista-input[data-mayorista="${mayoristaId}"]`);
        if (item.assigned > 0) {
          input.value = item.assigned;
          totalAsignado += item.assigned;
        }
      });
      
      input.value = totalAsignado;
      
      updateAllValues();
    }

    function clearMayoristaValues(event) {
      const btn = event.target.closest('.vscode-button');
      const mayoristaId = btn.dataset.mayorista;
      
      const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
      if (globalInput) globalInput.value = '0';
      
      document.querySelectorAll(`.mayorista-input[data-mayorista="${mayoristaId}"]`).forEach(input => {
        input.value = '0';
      });
      
      if (mayoristaFilters[mayoristaId]) {
        mayoristaFilters[mayoristaId].excludedColors = [];
        mayoristaFilters[mayoristaId].excludedTallas = [];
      }
      
      updateAllValues();
    }

    function openFilterModal(event) {
      const btn = event.target.closest('.vscode-button');
      const mayoristaId = btn.dataset.mayorista;
      const mayorista = allConfigData[mayoristaId];
      
      if (!currentRecData || !currentRecData.HR || currentRecData.HR.length === 0) {
        alert('Primero busque un REC para configurar los filtros');
        return;
      }
      
      const colors = new Set();
      const tallas = new Set();
      
      currentRecData.HR.forEach(row => {
        if (row[1]) colors.add(row[1]);
        if (row[2]) tallas.add(row[2]);
      });
      
      colorOptions = Array.from(colors);
      tallaOptions = Array.from(tallas);
      
      if (!mayoristaFilters[mayoristaId]) {
        mayoristaFilters[mayoristaId] = {
          excludedColors: [],
          excludedTallas: []
        };
      }
      
      const colorContainer = document.getElementById('colorFilters');
      const tallaContainer = document.getElementById('tallaFilters');
      
      colorContainer.innerHTML = '';
      tallaContainer.innerHTML = '';
      
      colorOptions.forEach(color => {
        const div = document.createElement('div');
        div.className = 'filter-option';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `color-${mayoristaId}-${color}`;
        checkbox.value = color;
        checkbox.checked = mayoristaFilters[mayoristaId].excludedColors.includes(color);
        
        const label = document.createElement('label');
        label.htmlFor = `color-${mayoristaId}-${color}`;
        label.textContent = color;
        label.style.cursor = 'pointer';
        
        div.appendChild(checkbox);
        div.appendChild(label);
        colorContainer.appendChild(div);
      });
      
      tallaOptions.forEach(talla => {
        const div = document.createElement('div');
        div.className = 'filter-option';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `talla-${mayoristaId}-${talla}`;
        checkbox.value = talla;
        checkbox.checked = mayoristaFilters[mayoristaId].excludedTallas.includes(talla);
        
        const label = document.createElement('label');
        label.htmlFor = `talla-${mayoristaId}-${talla}`;
        label.textContent = talla;
        label.style.cursor = 'pointer';
        
        div.appendChild(checkbox);
        div.appendChild(label);
        tallaContainer.appendChild(div);
      });
      
      document.getElementById('applyFilters').onclick = function() {
        mayoristaFilters[mayoristaId].excludedColors = Array.from(
          document.querySelectorAll('#colorFilters input[type="checkbox"]:checked')
        ).map(cb => cb.value);
        
        mayoristaFilters[mayoristaId].excludedTallas = Array.from(
          document.querySelectorAll('#tallaFilters input[type="checkbox"]:checked')
        ).map(cb => cb.value);
        
        closeModal('filterModal');
        
        const globalInput = document.querySelector(`.global-mayorista-input[data-mayorista="${mayoristaId}"]`);
        const valorGlobal = parseInt(globalInput?.value) || 0;
        
        if (valorGlobal > 0) {
          const distributeBtn = document.querySelector(`.vscode-button[data-mayorista="${mayoristaId}"]`);
          if (distributeBtn) {
            distributeBtn.click();
          }
        }
      };
      
      openModal('filterModal');
    }

    function smartDistribution(availableRows, totalQty) {
      // Mantengo todas las funciones de distribución inteligente del código original
      const totalAvailable = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      const uniqueItems = availableRows.length;
      const scenario = classifyScenario(totalQty, uniqueItems, totalAvailable);
      
      switch(scenario) {
        case 'LOW_QUANTITY': return distributeLowQuantity(availableRows, totalQty);
        case 'BALANCED': return distributeBalanced(availableRows, totalQty);
        case 'HIGH_QUANTITY': return distributeHighQuantity(availableRows, totalQty);
        case 'LIMITED_STOCK': return distributeLimitedStock(availableRows, totalQty);
        default: return distributeDefault(availableRows, totalQty);
      }
    }
    
    function classifyScenario(totalQty, uniqueItems, totalAvailable) {
      const avgPerItem = totalQty / uniqueItems;
      const stockRatio = totalQty / totalAvailable;
      
      if (totalQty <= uniqueItems) return 'LOW_QUANTITY';
      else if (avgPerItem < 3 && stockRatio < 0.3) return 'BALANCED';
      else if (stockRatio > 0.7) return 'HIGH_QUANTITY';
      else if (totalAvailable / uniqueItems < 2) return 'LIMITED_STOCK';
      return 'DEFAULT';
    }
    
    function distributeLowQuantity(availableRows, totalQty) {
      const prioritized = [...availableRows].sort((a, b) => {
        const priorityA = (a.tdm * 0.7) + (a.historicRotation * 0.3);
        const priorityB = (b.tdm * 0.7) + (b.historicRotation * 0.3);
        return priorityB - priorityA;
      });
      
      return prioritized.map((row, index) => ({
        ...row,
        assigned: index < totalQty ? 1 : 0
      })).filter(row => row.assigned > 0);
    }
    
    function distributeBalanced(availableRows, totalQty) {
      const basePerItem = Math.floor(totalQty / availableRows.length);
      let remaining = totalQty - (basePerItem * availableRows.length);
      
      let distributed = availableRows.map(row => {
        const assigned = Math.min(basePerItem, row.tdm);
        return { ...row, assigned };
      });
      
      if (remaining > 0) {
        distributed.sort((a, b) => (b.tdm - b.assigned) - (a.tdm - a.assigned));
        
        for (let i = 0; i < distributed.length && remaining > 0; i++) {
          const available = distributed[i].tdm - distributed[i].assigned;
          if (available > 0) {
            distributed[i].assigned += 1;
            remaining -= 1;
          }
        }
      }
      
      return distributed;
    }
    
    function distributeHighQuantity(availableRows, totalQty) {
      const totalStock = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      let remaining = totalQty;
      
      let distributed = availableRows.map(row => {
        const proportion = row.tdm / totalStock;
        let assigned = Math.max(1, Math.floor(proportion * totalQty));
        assigned = Math.min(assigned, row.tdm);
        remaining -= assigned;
        return { ...row, assigned };
      });
      
      if (remaining !== 0) {
        distributed.sort((a, b) => {
          const deviationA = (a.assigned / a.tdm) - (totalQty / totalStock);
          const deviationB = (b.assigned / b.tdm) - (totalQty / totalStock);
          return Math.abs(deviationB) - Math.abs(deviationA);
        });
        
        for (let i = 0; i < distributed.length && remaining !== 0; i++) {
          const row = distributed[i];
          const canAdd = remaining > 0 ? row.tdm - row.assigned : row.assigned;
          
          if (canAdd > 0) {
            const adjustment = remaining > 0 ? 1 : -1;
            row.assigned += adjustment;
            remaining -= adjustment;
          }
        }
      }
      
      return distributed;
    }
    
    function distributeLimitedStock(availableRows, totalQty) {
      const totalStock = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      let remaining = totalQty;
      
      let distributed = availableRows.map(row => {
        let assigned = Math.min(1, row.tdm);
        remaining -= assigned;
        return { ...row, assigned };
      });
      
      if (remaining > 0) {
        const remainingStock = totalStock - availableRows.length;
        distributed.forEach(row => {
          if (remaining <= 0) return;
          
          const additional = Math.min(
            Math.floor((row.tdm - 1) / remainingStock * remaining),
            row.tdm - row.assigned
          );
          
          if (additional > 0) {
            row.assigned += additional;
            remaining -= additional;
          }
        });
      }
      
      if (remaining > 0) {
        distributed.sort((a, b) => b.tdm - a.tdm);
        for (let i = 0; i < distributed.length && remaining > 0; i++) {
          const available = distributed[i].tdm - distributed[i].assigned;
          if (available > 0) {
            const toAdd = Math.min(available, remaining);
            distributed[i].assigned += toAdd;
            remaining -= toAdd;
          }
        }
      }
      
      return distributed;
    }
    
    function distributeDefault(availableRows, totalQty) {
      const totalStock = availableRows.reduce((sum, row) => sum + row.tdm, 0);
      let remaining = totalQty;
      
      let distributed = availableRows.map(row => {
        const proportion = row.tdm / totalStock;
        let assigned = Math.floor(proportion * totalQty);
        assigned = Math.min(assigned, row.tdm);
        remaining -= assigned;
        return { ...row, assigned };
      });
      
      if (remaining > 0) {
        distributed.sort((a, b) => (b.tdm - b.assigned) - (a.tdm - a.assigned));
        
        for (let i = 0; i < distributed.length && remaining > 0; i++) {
          const available = distributed[i].tdm - distributed[i].assigned;
          if (available > 0) {
            distributed[i].assigned += 1;
            remaining -= 1;
          }
        }
      }
      
      return distributed;
    }

    function saveAllDistributionsFast() {
      Swal.fire({
        icon: 'info',
        title: 'Función de Guardar',
        text: 'La función de guardar está lista para implementarse',
        confirmButtonText: 'Entendido'
      });
    }

    function confirmarCambio() {
      Swal.fire({
        title: '¿Estás seguro?',
        text: "Esta función requiere Google Apps Script para funcionar",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Entendido',
        cancelButtonText: 'Cancelar'
      });
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    // Inicialización
    window.addEventListener('DOMContentLoaded', initialize);

    // Atajo de teclado Ctrl+Q
    document.addEventListener('keydown', function(event) {
      if ((event.ctrlKey || event.metaKey) && (event.key === 'q' || event.key === 'Q')) {
        event.preventDefault();
        saveAllDistributionsFast();
      }
    });
  </script>
</body>
</html>