const SPREADSHEET_ID = '1VaPBwgRu1QWhmsV_Qgf7cgraSxiAWRX6-wBEyUlGoJw';
const SHEET_NAME = 'SOPORTES';
const FOLDER_ID = '1uaC605ZYOJKbdNJinVrvGAAo5tLAQRtO';

/**
 * Función para obtener fecha y hora formateada en formato estándar
 * Formato: DD/MM/YYYY HH:MM:SS
 */
function getFormattedDateTime(date = new Date()) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

/**
 * Función principal que maneja las solicitudes POST
 */
function doPost(e) {
  try {
    if (!e || !e.parameter) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'No se recibieron datos'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // VERIFICAR ACCIÓN
    if (e.parameter.action === 'delete') {
       return eliminarRegistro(e.parameter.factura);
    } else if (e.parameter.action === 'login') {
       return verificarCredenciales(e.parameter.id, e.parameter.password);
    }
    
    // Obtener los datos para GUARDAR
    const datos = {
        documento: e.parameter.documento || '',
        lote: e.parameter.lote || '',
        referencia: e.parameter.referencia || '',
        cantidad: e.parameter.cantidad || 0,
        factura: e.parameter.factura || '',
        nit: e.parameter.nit || '',
        fotoUrl: ''
    };
    if (e.parameter.fotoBase64 && e.parameter.fotoNombre && e.parameter.fotoTipo) {
      try {
        const fotoUrl = guardarImagenEnDrive(
          e.parameter.fotoBase64,
          e.parameter.fotoNombre,
          e.parameter.fotoTipo
        );
        datos.fotoUrl = fotoUrl;
      } catch (imgError) {
        Logger.log('Error al procesar la imagen: ' + imgError.message);
      }
    }
    
    // Guardar datos en la hoja
    const resultado = guardarDatosAlInicio(datos);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: resultado
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('Error en doPost: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Guardar imagen en Google Drive
 */
function guardarImagenEnDrive(base64Data, fileName, mimeType) {
  try {
    const decodedData = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const file = folder.createFile(blob);
    file.setName(fileName);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return file.getUrl();
  } catch (error) {
    Logger.log('Error en guardarImagenEnDrive: ' + error.message);
    throw new Error('No se pudo guardar la imagen: ' + error.message);
  }
}

/**
 * Función para ELIMINAR un registro basado en la factura
 */
function eliminarRegistro(facturaEliminar) {
  if (!facturaEliminar) {
     return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'No se proporcionó factura para eliminar'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const sheets = Sheets.Spreadsheets.Values;
    const allDataResponse = sheets.get(SPREADSHEET_ID, `${SHEET_NAME}!A:I`);
    
    if (!allDataResponse.values || allDataResponse.values.length === 0) {
       return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'No hay datos en la hoja'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    let values = allDataResponse.values;
    const headers = values[0];
    
    // Buscar índice de columna Factura
    let colFactura = -1;
    for (let i = 0; i < headers.length; i++) {
      if (headers[i].toString().toUpperCase().includes('FACTURA')) {
        colFactura = i;
        break;
      }
    }
    
    // Si no encuentra columna por nombre, asume índice 5 (F) por defecto
    if (colFactura === -1) colFactura = 5;
    
    // Filtrar: mantener filas que NO coincidan con la factura
    // Mantenemos headers (index 0)
    const newValues = [headers];
    let deletedCount = 0;
    
    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      // Comparamos como string para evitar problemas de tipos
      if (row[colFactura].toString() !== facturaEliminar.toString()) {
        newValues.push(row);
      } else {
        deletedCount++;
      }
    }
    
    if (deletedCount === 0) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false, // Cambiado a false porque no se encontró nada para borrar, aunque técnicamente no es error.
        message: 'No se encontró la factura para eliminar'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Limpiar hoja antes de escribir
    Sheets.Spreadsheets.Values.clear({}, SPREADSHEET_ID, `${SHEET_NAME}!A:I`);
    
    // Escribir datos actualizados
    Sheets.Spreadsheets.Values.update(
      { values: newValues },
      SPREADSHEET_ID,
      `${SHEET_NAME}!A1`,
      { valueInputOption: 'USER_ENTERED' }
    );
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: `Se eliminó el registro de la factura ${facturaEliminar}`
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
     Logger.log('Error al eliminar: ' + error.toString());
     return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error al eliminar: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Guardar datos AL INICIO de la hoja
 */
function guardarDatosAlInicio(datos) { 
  try {
    // Formato de fecha
    const fechaHora = getFormattedDateTime();

    // Extraer ID de Drive
    let fileId = null;
    let imageLink = '';
    if (datos.fotoUrl) {
      const match = datos.fotoUrl.match(/\/d\/([^/]+)\//);
      if (match && match[1]) {
        fileId = match[1];
        // URL DIRECTA de la imagen (SIN HIPERVÍNCULO)
        imageLink = `https://lh3.googleusercontent.com/d/${fileId}`;
      }
    }

    // Preparar fila de datos
    const nuevaFila = [
      fechaHora,
      datos.documento,
      datos.lote,
      datos.referencia,
      datos.cantidad,
      datos.factura,
      datos.nit,
      fileId || 'Sin ID',
      imageLink // URL DIRECTA aquí
    ];

    // Obtener datos existentes
    const sheets = Sheets.Spreadsheets.Values;
    const allDataResponse = sheets.get(SPREADSHEET_ID, `${SHEET_NAME}!A:I`);
    
    // Construir nueva estructura con fila al inicio
    let allData = [];
    
    if (allDataResponse.values && allDataResponse.values.length > 0) {
      // Agregar encabezados
      allData.push(allDataResponse.values[0]);
      
      // Agregar NUEVA FILA en posición 2 (después de encabezados)
      allData.push(nuevaFila);
      
      // Agregar filas existentes
      for (let i = 1; i < allDataResponse.values.length; i++) {
        allData.push(allDataResponse.values[i]);
      }
    } else {
      // Crear encabezados si no existen
      const encabezados = [
        'Fecha y Hora', 'Documento', 'Lote', 'Referencia', 
        'Cantidad', 'Factura', 'NIT', 'ID Imagen', 'Link Imagen'
      ];
      allData.push(encabezados);
      allData.push(nuevaFila);
    }
    
    // Limitar a 1000 registros máximo
    const MAX_FILAS = 1000;
    const totalFilasPermitidas = MAX_FILAS + 1;
    
    if (allData.length > totalFilasPermitidas) {
      allData = allData.slice(0, totalFilasPermitidas);
    }
    
    // Actualizar toda la hoja
    const updateRange = {
      values: allData
    };

    sheets.update(
      updateRange,
      SPREADSHEET_ID,
      `${SHEET_NAME}!A:I`,
      {
        valueInputOption: 'USER_ENTERED'
      }
    );

    return "¡Datos guardados correctamente al inicio!";

  } catch (error) {
    Logger.log('Error al guardar datos: ' + error.toString());
    throw new Error('No se pudieron guardar los datos: ' + error.message);
  }
}

/**
 * Función para verificar credenciales de usuario
 */
function verificarCredenciales(id, password) {
  if (!id || !password) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Credenciales incompletas'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const sheets = Sheets.Spreadsheets.Values;
    const response = sheets.get(SPREADSHEET_ID, `USUARIOS!A:D`);
    
    if (!response.values || response.values.length < 2) {
       return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'Base de datos de usuarios vacía'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    const values = response.values;
    // Asumimos headers en la fila 0: ID, USUARIO, ROL, PASSWORD
    // Indices (0-based): ID=0, USUARIO=1, ROL=2, PASSWORD=3
    
    // Buscar usuario
    let userFound = null;
    
    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      // Comparar ID y Password (exactmatch)
      if (String(row[0]).trim() === String(id).trim() && String(row[3]).trim() === String(password).trim()) {
        userFound = {
          id: row[0],
          nombre: row[1],
          rol: row[2]
        };
        break;
      }
    }

    if (userFound) {
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        user: userFound
      })).setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'ID o contraseña incorrectos'
      })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    Logger.log('Error en login: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error en el servidor: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}