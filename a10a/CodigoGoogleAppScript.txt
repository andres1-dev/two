const SPREADSHEET_ID = '1VaPBwgRu1QWhmsV_Qgf7cgraSxiAWRX6-wBEyUlGoJw';
const SHEET_NAME = 'SOPORTES';
const FOLDER_ID = '1uaC605ZYOJKbdNJinVrvGAAo5tLAQRtO';

/**
 * Función para obtener fecha y hora formateada en formato estándar
 * Formato: DD/MM/YYYY HH:MM:SS
 */
function getFormattedDateTime(date = new Date()) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

/**
 * Función principal que maneja las solicitudes POST
 */
function doPost(e) {
  try {
    if (!e || !e.parameter) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'No se recibieron datos'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // VERIFICAR ACCIÓN
    if (e.parameter.action === 'delete') {
       return eliminarRegistro(e.parameter.factura);
    } else if (e.parameter.action === 'login') {
       return verificarCredenciales(e.parameter.id, e.parameter.password);
    } else if (e.parameter.action === 'recover') {
       return recuperarContrasena(e.parameter.id, e.parameter.method);
    }
    
    // Obtener los datos para GUARDAR
    const datos = {
        documento: e.parameter.documento || '',
        lote: e.parameter.lote || '',
        referencia: e.parameter.referencia || '',
        cantidad: e.parameter.cantidad || 0,
        factura: e.parameter.factura || '',
        nit: e.parameter.nit || '',
        fotoUrl: ''
    };
    if (e.parameter.fotoBase64 && e.parameter.fotoNombre && e.parameter.fotoTipo) {
      try {
        const fotoUrl = guardarImagenEnDrive(
          e.parameter.fotoBase64,
          e.parameter.fotoNombre,
          e.parameter.fotoTipo
        );
        datos.fotoUrl = fotoUrl;
      } catch (imgError) {
        Logger.log('Error al procesar la imagen: ' + imgError.message);
      }
    }
    
    // Guardar datos en la hoja
    const resultado = guardarDatosAlInicio(datos);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: resultado
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('Error en doPost: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * CONFIGURACIÓN DE USUARIOS (Ejecutar una vez manualmente)
 */
function setupUsers() {
  const users = [
    {
      id: "1144167164",
      nombre: "CARLOS ANDRES MENDOZA ARIAS",
      rol: "ADMIN",
      password: "Slipknot!4338070*",
      email: "coordinadorlogistico@eltemplodelamoda.com.co",
      phone: "573168007979"
    },
    {
      id: "1143978191",
      nombre: "GUSTAVO ADOLFO CAICEDO CAICEDO",
      rol: "DELIVERY",
      password: "654321",
      email: "guspoetics1@icloud.com",
      phone: "573207754869"
    }
  ];
  
  PropertiesService.getScriptProperties().setProperty('USERS', JSON.stringify(users));
  Logger.log('Usuarios configurados correctamente en PropertiesService');
}

/**
 * Obtener usuarios desde PropertiesService
 */
function getUsers() {
  const usersJson = PropertiesService.getScriptProperties().getProperty('USERS');
  if (!usersJson) return [];
  return JSON.parse(usersJson);
}

/**
 * Función para verificar credenciales de usuario (Desde Properties)
 */
function verificarCredenciales(id, password) {
  if (!id || !password) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Credenciales incompletas'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const users = getUsers();
    const userFound = users.find(u => u.id === String(id).trim() && u.password === String(password).trim());

    if (userFound) {
      // No devolvemos la contraseña ni datos sensibles
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        user: {
          id: userFound.id,
          nombre: userFound.nombre,
          rol: userFound.rol
        }
      })).setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'ID o contraseña incorrectos'
      })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    Logger.log('Error en login: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error en el servidor: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Función para recuperar contraseña
 */
function recuperarContrasena(id, method) {
  if (!id) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Se requiere el ID'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const users = getUsers();
    const user = users.find(u => u.id === String(id).trim());
    
    if (!user) {
       return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'Usuario no encontrado'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // Envío por Email
    if (user.email) {
        MailApp.sendEmail({
          to: user.email,
          subject: "Recuperación de Contraseña - PandaDash",
          htmlBody: `
            <h3>Hola ${user.nombre}</h3>
            <p>Has solicitado recuperar tu contraseña para la aplicación <strong>PandaDash</strong>.</p>
            <p>Tu contraseña es: <strong>${user.password}</strong></p>
            <p>Por favor, intenta memorizarla o guárdala en un lugar seguro.</p>
            <br>
            <p><small>Este es un mensaje automático del sistema.</small></p>
          `
        });
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          message: `Contraseña enviada al correo registrado (${user.email})`
        })).setMimeType(ContentService.MimeType.JSON);
    } else {
       return ContentService.createTextOutput(JSON.stringify({
          success: false,
          message: 'El usuario no tiene un correo electrónico registrado'
        })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    Logger.log('Error en recuperación: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error al procesar la solicitud: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Función para eliminar un registro y su imagen asociada
 */
function eliminarRegistro(facturaEliminar) {
  if (!facturaEliminar) {
     return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'No se proporcionó factura para eliminar'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const sheets = Sheets.Spreadsheets.Values;
    const allDataResponse = sheets.get(SPREADSHEET_ID, `${SHEET_NAME}!A:I`);
    
    if (!allDataResponse.values || allDataResponse.values.length === 0) {
       return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'No hay datos en la hoja'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    let values = allDataResponse.values;
    const headers = values[0];
    
    // Buscar índice de columna Factura e ID Imagen
    let colFactura = -1;
    let colIdImagen = -1;
    
    for (let i = 0; i < headers.length; i++) {
      const header = headers[i].toString().toUpperCase();
      if (header.includes('FACTURA')) {
        colFactura = i;
      }
      if (header.includes('ID IMAGEN')) {
        colIdImagen = i;
      }
    }
    
    // Si no encuentra columna por nombre, asume índice 5 (F) por defecto para Factura
    // y índice 7 (H) para ID Imagen
    if (colFactura === -1) colFactura = 5;
    if (colIdImagen === -1) colIdImagen = 7;
    
    // Filtrar: mantener filas que NO coincidan con la factura
    // Mantenemos headers (index 0)
    const newValues = [headers];
    let deletedCount = 0;
    
    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      // Comparamos como string para evitar problemas de tipos
      if (row[colFactura].toString() !== facturaEliminar.toString()) {
        newValues.push(row);
      } else {
        // Encontramos el registro a eliminar
        deletedCount++;
        
        // Intentar eliminar la imagen de Google Drive
        if (colIdImagen !== -1 && row[colIdImagen] && row[colIdImagen] !== 'Sin ID') {
          try {
             // Usamos setTrashed(true) para enviar a la papelera (más seguro)
             // Ojo: row[colIdImagen] debe ser el ID puro del archivo
             DriveApp.getFileById(row[colIdImagen]).setTrashed(true);
             Logger.log(`Imagen eliminada (al papelera): ${row[colIdImagen]}`);
          } catch(e) {
             Logger.log(`Error eliminando imagen ${row[colIdImagen]}: ${e.message}`);
             // Continuamos eliminando el registro aunque falle la eliminación de la imagen
          }
        }
      }
    }
    
    if (deletedCount === 0) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'No se encontró la factura para eliminar'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Limpiar hoja antes de escribir
    Sheets.Spreadsheets.Values.clear({}, SPREADSHEET_ID, `${SHEET_NAME}!A:I`);
    
    // Escribir datos actualizados
    Sheets.Spreadsheets.Values.update(
      { values: newValues },
      SPREADSHEET_ID,
      `${SHEET_NAME}!A1`,
      { valueInputOption: 'USER_ENTERED' }
    );
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: `Se eliminó el registro de la factura ${facturaEliminar} y su imagen asociada`
    })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
     Logger.log('Error al eliminar: ' + error.toString());
     return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error al eliminar: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function guardarImagenEnDrive(base64Data, fileName, mimeType) {
  try {
    const decodedData = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const file = folder.createFile(blob);
    file.setName(fileName);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return file.getUrl();
  } catch (error) {
    Logger.log('Error en guardarImagenEnDrive: ' + error.message);
    throw new Error('No se pudo guardar la imagen: ' + error.message);
  }
}

function guardarDatosAlInicio(datos) { 
  try {
    // Formato de fecha
    const fechaHora = getFormattedDateTime();

    // Extraer ID de Drive
    let fileId = null;
    let imageLink = '';
    if (datos.fotoUrl) {
      const match = datos.fotoUrl.match(/\/d\/([^/]+)\//);
      if (match && match[1]) {
        fileId = match[1];
        // URL DIRECTA de la imagen (SIN HIPERVÍNCULO)
        imageLink = `https://lh3.googleusercontent.com/d/${fileId}`;
      }
    }

    // Preparar fila de datos
    const nuevaFila = [
      fechaHora,
      datos.documento,
      datos.lote,
      datos.referencia,
      datos.cantidad,
      datos.factura,
      datos.nit,
      fileId || 'Sin ID',
      imageLink // URL DIRECTA aquí
    ];

    // Obtener datos existentes
    const sheets = Sheets.Spreadsheets.Values;
    const allDataResponse = sheets.get(SPREADSHEET_ID, `${SHEET_NAME}!A:I`);
    
    // Construir nueva estructura con fila al inicio
    let allData = [];
    
    if (allDataResponse.values && allDataResponse.values.length > 0) {
      // Agregar encabezados
      allData.push(allDataResponse.values[0]);
      
      // Agregar NUEVA FILA en posición 2 (después de encabezados)
      allData.push(nuevaFila);
      
      // Agregar filas existentes
      for (let i = 1; i < allDataResponse.values.length; i++) {
        allData.push(allDataResponse.values[i]);
      }
    } else {
      // Crear encabezados si no existen
      const encabezados = [
        'Fecha y Hora', 'Documento', 'Lote', 'Referencia', 
        'Cantidad', 'Factura', 'NIT', 'ID Imagen', 'Link Imagen'
      ];
      allData.push(encabezados);
      allData.push(nuevaFila);
    }
    
    // Limitar a 1000 registros máximo (ajustar seguridad)
    const MAX_FILAS = 1000;
    const totalFilasPermitidas = MAX_FILAS + 1;
    
    if (allData.length > totalFilasPermitidas) {
      allData = allData.slice(0, totalFilasPermitidas);
    }
    
    // Actualizar toda la hoja
    const updateRange = {
      values: allData
    };

    sheets.update(
      updateRange,
      SPREADSHEET_ID,
      `${SHEET_NAME}!A:I`,
      {
        valueInputOption: 'USER_ENTERED'
      }
    );

    return "¡Datos guardados correctamente al inicio!";

  } catch (error) {
    Logger.log('Error al guardar datos: ' + error.toString());
    throw new Error('No se pudieron guardar los datos: ' + error.message);
  }
}