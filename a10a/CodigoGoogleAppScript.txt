const SPREADSHEET_ID = '1VaPBwgRu1QWhmsV_Qgf7cgraSxiAWRX6-wBEyUlGoJw';
const SHEET_NAME = 'SOPORTES';
const FOLDER_ID = '1uaC605ZYOJKbdNJinVrvGAAo5tLAQRtO';

/**
 * Función para obtener fecha y hora formateada en formato estándar
 * Formato: DD/MM/YYYY HH:MM:SS
 */
function getFormattedDateTime(date = new Date()) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

/**
 * Función principal que maneja las solicitudes POST
 */
function doPost(e) {
  try {
    if (!e || !e.parameter) {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'No se recibieron datos'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // VERIFICAR ACCIÓN
    if (e.parameter.action === 'delete') {
       return eliminarRegistro(e.parameter.factura);
    } else if (e.parameter.action === 'login') {
       return verificarCredenciales(e.parameter.id, e.parameter.password);
    } else if (e.parameter.action === 'recover') {
       return recuperarContrasena(e.parameter.id, e.parameter.method);
    }
    
    // Obtener los datos para GUARDAR
    const datos = {
        documento: e.parameter.documento || '',
        lote: e.parameter.lote || '',
        referencia: e.parameter.referencia || '',
        cantidad: e.parameter.cantidad || 0,
        factura: e.parameter.factura || '',
        nit: e.parameter.nit || '',
        fotoUrl: ''
    };
    if (e.parameter.fotoBase64 && e.parameter.fotoNombre && e.parameter.fotoTipo) {
      try {
        const fotoUrl = guardarImagenEnDrive(
          e.parameter.fotoBase64,
          e.parameter.fotoNombre,
          e.parameter.fotoTipo
        );
        datos.fotoUrl = fotoUrl;
      } catch (imgError) {
        Logger.log('Error al procesar la imagen: ' + imgError.message);
      }
    }
    
    // Guardar datos en la hoja
    const resultado = guardarDatosAlInicio(datos);
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: resultado
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    Logger.log('Error en doPost: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * CONFIGURACIÓN DE USUARIOS (Ejecutar una vez manualmente)
 */
function setupUsers() {
  const users = [
    {
      id: "1144167164",
      nombre: "CARLOS ANDRES MENDOZA ARIAS",
      rol: "ADMIN",
      password: "Slipknot!4338070*",
      email: "coordinadorlogistico@eltemplodelamoda.com.co",
      phone: "573168007979"
    },
    {
      id: "1143978191",
      nombre: "GUSTAVO ADOLFO CAICEDO CAICEDO",
      rol: "DELIVERY",
      password: "654321",
      email: "guspoetics1@icloud.com",
      phone: "573207754869"
    }
  ];
  
  PropertiesService.getScriptProperties().setProperty('USERS', JSON.stringify(users));
  Logger.log('Usuarios configurados correctamente en PropertiesService');
}

/**
 * Obtener usuarios desde PropertiesService
 */
function getUsers() {
  const usersJson = PropertiesService.getScriptProperties().getProperty('USERS');
  if (!usersJson) return [];
  return JSON.parse(usersJson);
}

/**
 * Función para verificar credenciales de usuario (Desde Properties)
 */
function verificarCredenciales(id, password) {
  if (!id || !password) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Credenciales incompletas'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const users = getUsers();
    const userFound = users.find(u => u.id === String(id).trim() && u.password === String(password).trim());

    if (userFound) {
      // No devolvemos la contraseña ni datos sensibles
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        user: {
          id: userFound.id,
          nombre: userFound.nombre,
          rol: userFound.rol
        }
      })).setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'ID o contraseña incorrectos'
      })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    Logger.log('Error en login: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error en el servidor: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Función para recuperar contraseña
 */
function recuperarContrasena(id, method) {
  if (!id) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Se requiere el ID'
    })).setMimeType(ContentService.MimeType.JSON);
  }

  try {
    const users = getUsers();
    const user = users.find(u => u.id === String(id).trim());
    
    if (!user) {
       return ContentService.createTextOutput(JSON.stringify({
        success: false,
        message: 'Usuario no encontrado'
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // Envío por Email
    if (user.email) {
        MailApp.sendEmail({
          to: user.email,
          subject: "Recuperación de Contraseña - PandaDash",
          htmlBody: `
            <h3>Hola ${user.nombre}</h3>
            <p>Has solicitado recuperar tu contraseña para la aplicación <strong>PandaDash</strong>.</p>
            <p>Tu contraseña es: <strong>${user.password}</strong></p>
            <p>Por favor, intenta memorizarla o guárdala en un lugar seguro.</p>
            <br>
            <p><small>Este es un mensaje automático del sistema.</small></p>
          `
        });
        
        return ContentService.createTextOutput(JSON.stringify({
          success: true,
          message: `Contraseña enviada al correo registrado (${user.email})`
        })).setMimeType(ContentService.MimeType.JSON);
    } else {
       return ContentService.createTextOutput(JSON.stringify({
          success: false,
          message: 'El usuario no tiene un correo electrónico registrado'
        })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    Logger.log('Error en recuperación: ' + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      message: 'Error al procesar la solicitud: ' + error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}